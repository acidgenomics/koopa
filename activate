#!/bin/sh
# shellcheck disable=SC3040

__koopa_activate_usage() { # {{{1
    # """
    # Koopa activation usage triggered by '--help' flag.
    # @note Updated 2021-05-07.
    # """
    cat << END
usage: activate [--help|-h]

Activate koopa.

optional variables:
    force=0 [false]
        Force activation inside of non-interactive shells.
        Not generally recommended, but used by koopa installer.
    minimal=0 [false]
        Minimal mode.
        Simply load koopa programs into PATH.
        Skips additional program and shell configuration.
        Can enable per user with 'KOOPA_USERS_MINIMAL=user1 user2'.
    test=0 [false]
        Enable verbose test mode.
        Used for Travis CI checks.

details:
    Currently supports Bash, Zsh, and Dash shells.

    For system-wide configuration on Linux, this should be called inside
    '/etc/profile.d/zzz-koopa.sh', owned by root.

    Activation of specific users can be skipped via:
    > export KOOPA_USERS_SKIP='user1 user2'

    Sourcing of POSIX shell scripts via '.' (POSIX) or 'source' (bash, zsh)
    requires that arguments are passed in at the beginning of the call, rather
    than as positional arguments or flags. Refer to the working examples.

examples:
    # Default mode.
    . /usr/local/koopa/activate

    # Minimal mode.
    minimal=1 . /usr/local/koopa/activate
END
}

__koopa_bash_source() { # {{{1
    # """
    # Bash source file location.
    # @note Updated 2021-05-07.
    # """
    # shellcheck disable=SC3028,SC3054
    __koopa_print "${BASH_SOURCE[0]}"
    return 0
}

__koopa_check_os() { # {{{1
    # """
    # Check that operating system is supported.
    # @note Updated 2021-05-07.
    # """
    case "$(uname -s)" in
        Darwin|Linux)
            ;;
        *)
            __koopa_warning 'Unsupported operating system.'
            return 1
            ;;
    esac
    return 0
}

__koopa_check_zsh() { # {{{1
    # """
    # Check that current Zsh configuration is supported.
    # @note Updated 2021-05-07.
    #
    # Zsh currently requires presence of '~/.zshrc' for clean activation.
    #
    # Note that sourcing in '/etc/profile' doesn't return script path in
    # '0', which is commonly recommended online in place of 'BASH_SOURCE'.
    # '0' in this case instead returns '_src_etc_profile'.
    #
    # This approach covers both '_src_etc_profile' and '_src_etc_profile_d'.
    #
    # @seealso
    # - https://stackoverflow.com/a/23259585/3911732
    [ "${KOOPA_SHELL:?}" = 'zsh' ] || return 0
    case "$0" in
        _src_etc_profile*)
            # Early return when sourced from '/etc/profile.d'.
            return 1
            ;;
        *)
            export KOOPA_ZSHRC=1
            ;;
    esac
    return 0
}

__koopa_duration_start() { # {{{1
    # """
    # Start duration timer.
    # @note Updated 2021-05-07.
    # """
    local bc date brew_prefix
    [ -z "${KOOPA_TEST:-}" ] || return 0
    if __koopa_is_macos
    then
        if [ -x '/opt/homebrew/bin/brew' ]
        then
            brew_prefix='/opt/homebrew'
        elif [ -x '/usr/local/bin/brew' ]
        then
            brew_prefix='/usr/local'
        else
            exit 0
            return 0
        fi
        bc="${brew_prefix}/opt/bc/bin/bc"
        date="${brew_prefix}/opt/coreutils/libexec/gnubin/date"
    else
        bc='bc'
        date='date'
    fi
    __koopa_is_installed "$bc" "$date" || return 0
    KOOPA_DURATION_START="$("$date" -u '+%s%3N')"
    export KOOPA_DURATION_START
    return 0
}

__koopa_duration_stop() { # {{{1
    # """
    # Stop duration timer.
    # @note Updated 2021-05-07.
    # """
    local bc date brew_prefix
    [ -z "${KOOPA_TEST:-}" ] || return 0
    if __koopa_is_macos
    then
        if [ -x '/opt/homebrew/bin/brew' ]
        then
            brew_prefix='/opt/homebrew'
        elif [ -x '/usr/local/bin/brew' ]
        then
            brew_prefix='/usr/local'
        else
            return 0
        fi
        bc="${brew_prefix}/opt/bc/bin/bc"
        date="${brew_prefix}/opt/coreutils/libexec/gnubin/date"
    else
        bc='bc'
        date='date'
    fi
    __koopa_is_installed "$bc" "$date" || return 0
    KOOPA_DURATION_STOP="$("$date" -u '+%s%3N')"
    KOOPA_DURATION="$( \
        __koopa_print "${KOOPA_DURATION_STOP:?}-${KOOPA_DURATION_START:?}" \
        | "$bc" \
    )"
    export KOOPA_DURATION
    unset -v KOOPA_DURATION_START KOOPA_DURATION_STOP
    return 0
}

__koopa_export_koopa_force() { # {{{1
    # """
    # Export 'KOOPA_FORCE' variable.
    # @note Updated 2021-05-07.
    # """
    [ "${KOOPA_FORCE:-0}" -eq 0 ] || return 0
    case "${force:-}" in
        0|false)
            KOOPA_FORCE=0
            ;;
        1|true)
            KOOPA_FORCE=1
            ;;
        *)
            KOOPA_FORCE=0
            ;;
    esac
    export KOOPA_FORCE
    unset -v force
    return 0
}

__koopa_export_koopa_interactive() { # {{{1
    # """
    # Export 'KOOPA_INTERACTIVE' variable.
    # @note Updated 2021-05-07.
    # """
    if __koopa_is_interactive || [ "${KOOPA_FORCE:-0}" -eq 1 ]
    then
        KOOPA_INTERACTIVE=1
        export KOOPA_INTERACTIVE
    fi
    return 0
}

__koopa_export_koopa_minimal() { # {{{1
    # """
    # Export 'KOOPA_MINIMAL' variable.
    # @note Updated 2021-05-07.
    # """
    [ -z "${KOOPA_MINIMAL:-}" ] || return 0
    case "${minimal:-}" in
        0|false)
            KOOPA_MINIMAL=0
            ;;
        1|true)
            KOOPA_MINIMAL=1
            ;;
        *)
            KOOPA_MINIMAL=0
            ;;
    esac
    unset -v minimal
    if [ -n "${KOOPA_USERS_MINIMAL:-}" ]
    then
        if __koopa_str_match_regex "${KOOPA_USERS_MINIMAL:?}" "\b${USER:?}\b"
        then
            KOOPA_MINIMAL=1
        fi
    fi
    export KOOPA_MINIMAL
    return 0
}

__koopa_export_koopa_prefix() { # {{{1
    # """
    # Export 'KOOPA_PREFIX' variable.
    # @note Updated 2021-05-07.
    # """
    local shell
    case "${KOOPA_SHELL:?}" in
        bash|zsh)
            shell="${KOOPA_SHELL:?}"
            ;;
        *)
            shell='posix'
            ;;
    esac
    KOOPA_ACTIVATE_SCRIPT="$("__koopa_${shell}_source")"
    if [ ! -x "$KOOPA_ACTIVATE_SCRIPT" ]
    then
        __koopa_warning 'Failed to locate koopa activate script.'
        return 1
    fi
    # Note that running realpath on the file instead of the directory will
    # properly resolve '~/.config/koopa/activate' symlink case.
    if [ -L "$KOOPA_ACTIVATE_SCRIPT" ]
    then
        KOOPA_ACTIVATE_SCRIPT="$(__koopa_realpath "$KOOPA_ACTIVATE_SCRIPT")"
    fi
    KOOPA_PREFIX="$(__koopa_realpath "$(dirname "$KOOPA_ACTIVATE_SCRIPT")")"
    export KOOPA_ACTIVATE_SCRIPT KOOPA_PREFIX
    return 0
}

__koopa_export_koopa_shell() { # {{{1
    # """
    # Check that current shell is supported, and export 'KOOPA_SHELL' variable.
    # @note Updated 2021-05-07.
    # """
    if [ -n "${BASH_VERSION:-}" ]
    then
        KOOPA_SHELL='bash'
    elif [ -n "${ZSH_VERSION:-}" ]
    then
        KOOPA_SHELL='zsh'
    elif [ -d '/proc' ]
    then
        KOOPA_SHELL="$(basename "$(readlink "/proc/${$}/exe")")"
    else
        KOOPA_SHELL="$(basename "$(ps -p "${$}" -o 'comm=' | sed 's/^-//g')")"
    fi
    case "${KOOPA_SHELL:?}" in
        bash|dash|zsh)
            ;;
        *)
            if __koopa_is_interactive
            then
                >&2 cat << END
[koopa] WARNING: Failed to activate koopa in the current shell.

Supported POSIX shells: Bash, Dash, Zsh.

  KOOPA_SHELL : ${KOOPA_SHELL:-}
        SHELL : ${SHELL:-}
            - : ${-}
            0 : ${0}
            \$ : ${$}

Consider switching to Bash:
> chsh -s /bin/bash ${USER:-}
or Zsh:
> chsh -s /bin/zsh ${USER:-}
END
            fi
            return 1
            ;;
    esac
    export KOOPA_SHELL
    return 0
}

__koopa_export_koopa_subshell() { # {{{1
    # """
    # Export 'KOOPA_SUBSHELL' variable.
    # @note Updated 2021-05-07.
    #
    # This function evaluates whether 'KOOPA_PREFIX' is defined, which should be
    # the case only inside a subshell.
    # """
    [ -z "${KOOPA_PREFIX:-}" ] && return 0
    KOOPA_SUBSHELL=1
    export KOOPA_SUBSHELL
    return 0
}

__koopa_export_koopa_test() { # {{{1
    # """
    # Export 'KOOPA_TEST' variable.
    # @note Updated 2021-05-07.
    # """
    [ "${KOOPA_TEST:-0}" -eq 0 ] || return 0
    case "${test:-}" in
        0|false)
            KOOPA_TEST=0
            ;;
        1|true)
            KOOPA_TEST=1
            ;;
        *)
            KOOPA_TEST=0
            ;;
    esac
    export KOOPA_TEST
    unset -v test
    return 0
}

__koopa_export_user() { # {{{1
    # """
    # Export 'USER' variable.
    # @note Updated 2021-05-07.
    # """
    [ -z "${USER:-}" ] || return 0
    USER="$(id -un)"
    export USER
    return 0
}

__koopa_header() { # {{{1
    # """
    # Shared shell header file location.
    # @note Updated 2021-05-07.
    # """
    local file prefix shell
    prefix="${KOOPA_PREFIX:?}/lang/shell"
    shell="${KOOPA_SHELL:?}"
    [ -d "${prefix}/${shell}" ] || shell='posix'
    file="${prefix}/${shell}/include/header.sh"
    [ -f "$file" ] || return 1
    __koopa_print "$file"
    return 0
}

__koopa_is_installed() { # {{{1
    # """
    # Are all of the requested programs installed?
    # @note Updated 2021-05-07.
    # """
    local cmd
    for cmd in "$@"
    do
        command -v "$cmd" >/dev/null || return 1
    done
    return 0
}

__koopa_is_interactive() { # {{{1
    # """
    # Is the current shell interactive?
    # @note Updated 2021-05-07.
    # """
    __koopa_str_match_fixed "$-" 'i'
}

__koopa_is_koopa_active() { # {{{1
    # """
    # Is koopa active in the current shell session?
    # @note Updated 2021-05-07.
    # """
    local x
    x="$(type '_koopa_prefix' 2>/dev/null)"
    __koopa_str_match_fixed "$x" 'function'
}

__koopa_is_linux() { # {{{1
    # """
    # Is the operating system Linux?
    # @note Updated 2021-05-07.
    # """
    [ "$(uname -s)" = 'Linux' ]
}

__koopa_is_macos() { # {{{1
    # """
    # Is the operating system macOS?
    # @note Updated 2021-05-07.
    # """
    [ "$(uname -s)" = 'Darwin' ]
}

__koopa_is_subshell() { # {{{1
    # """
    # Is koopa running inside of a subshell?
    # @note Updated 2021-05-07.
    # """
    [ "${KOOPA_SUBSHELL:-0}" -eq 1 ]
}

__koopa_is_user_named_admin() { # {{{1
    # """
    # Is the current user named 'admin' or begin with 'admin'?
    # @note Updated 2021-05-07.
    # """
    __koopa_str_match_regex "${USER:?}" '^admin'
}

__koopa_is_user_manual_skip() { # {{{1
    # """
    # Should activation be manually skipped for the current user?
    # @note Updated 2021-05-07?
    # """
    [ -n "${KOOPA_USERS_SKIP:-}" ] || return 1
    __koopa_str_match_regex "${KOOPA_USERS_SKIP:?}" "\b${USER:?}\b"
}

__koopa_posix_source() { # {{{1
    # """
    # POSIX source file location.
    # @note Updated 2021-05-10.
    #
    # POSIX doesn't support file path resolution of sourced dot scripts.
    # """
    if [ ! -d "${KOOPA_PREFIX:-}" ] && __koopa_is_interactive
    then
        __koopa_warning \
            'Failed to locate koopa activation script.' \
            "Required 'KOOPA_PREFIX' variable is unset."
        return 1
    fi
    __koopa_print "${KOOPA_PREFIX:?}/activate"
    return 0
}

__koopa_preflight() { # {{{1
    # """
    # Run pre-flight checks.
    # @note Updated 2021-05-07.
    #
    # Determine whether koopa activation should proceed in the current shell.
    # """
    __koopa_export_user || return 1
    __koopa_export_koopa_force || return 1
    [ "${KOOPA_FORCE:-0}" -eq 0 ] || return 0
    [ "${KOOPA_SKIP:-0}" -eq 0 ] || return 1
    __koopa_export_koopa_shell || return 1
    __koopa_is_koopa_active && return 1
    __koopa_is_interactive || return 1
    __koopa_is_user_named_admin && return 1
    __koopa_is_user_manual_skip && return 1
    __koopa_check_os || return 1
    # This will intentionally skip for non-Zsh shells.
    __koopa_check_zsh || return 1
    return 0
}

__koopa_print() { # {{{1
    # """
    # Print a string.
    # @note Updated 2021-05-07.
    # """
    local string
    [ "$#" -gt 0 ] || return 1
    for string in "$@"
    do
        printf '%b\n' "$string"
    done
    return 0
}

__koopa_realpath() { # {{{1
    # """
    # Resolve file path.
    # @note Updated 2021-05-07.
    # """
    local arg bn dn x
    [ "$#" -gt 0 ] || return 1
    if __koopa_is_installed realpath
    then
        x="$(realpath "$@")"
    elif __koopa_is_installed grealpath
    then
        x="$(grealpath "$@")"
    elif __koopa_is_macos
    then
        for arg in "$@"
        do
            bn="$(basename "$arg")"
            dn="$(cd "$(dirname "$arg")" || return 1; pwd -P)"
            x="${dn}/${bn}"
            __koopa_print "$x"
        done
        return 0
    else
        x="$(readlink -f "$@")"
    fi
    [ -n "$x" ] || return 1
    __koopa_print "$x"
    return 0
}

__koopa_str_match_fixed() { # {{{1
    # """
    # Match a fixed pattern in a string.
    # @note Updated 2021-05-07.
    # """
    local string pattern
    string="${1:-}"
    pattern="${2:?}"
    __koopa_print "$string" | grep -q "$pattern"
}

__koopa_str_match_regex() { # {{{1
    # """
    # Match a regular expression pattern in a string.
    # @note Updated 2021-05-07.
    # """
    local string pattern
    string="${1:-}"
    pattern="${2:?}"
    __koopa_print "$string" | grep -Eq "$pattern"
}

__koopa_warning() { # {{{1
    # """
    # Print a warning message to the console.
    # @note Updated 2021-05-07.
    # """
    local string
    [ "$#" -gt 0 ] || return 1
    for string in "$@"
    do
        printf '%s: %b\n' '[koopa] WARNING' "$string" >&2
    done
    return 0
}

__koopa_zsh_source() { # {{{1
    # """
    # Zsh source file location.
    # @note Updated 2021-05-07.
    #
    # Use '%x' not '%N' when called inside function.
    # https://stackoverflow.com/a/23259585/3911732
    # """
    __koopa_print "${(%):-%x}"
    return 0
}

_koopa_activate() { # {{{1
    # """
    # Activate koopa bootloader inside shell session.
    # @note Updated 2021-05-07.
    # """
    case "${1:-}" in
        --help|-h)
            __koopa_activate_usage
            return 0
            ;;
    esac
    __koopa_preflight || return 0
    __koopa_export_koopa_interactive || return 1
    __koopa_export_koopa_minimal || return 1
    __koopa_export_koopa_subshell || return 1
    __koopa_export_koopa_test || return 1
    if [ "${KOOPA_TEST:-0}" -eq 1 ]
    then
        __koopa_print '[koopa] Test mode enabled.'
        set -o errexit
        set -o nounset
        # > set -o xtrace
        if [ "${KOOPA_SHELL:?}" = 'bash' ]
        then
            set -o errtrace
            set -o pipefail
        fi
    fi
    __koopa_duration_start || return 1
    __koopa_export_koopa_prefix || return 1
    # shellcheck source=/dev/null
    KOOPA_ACTIVATE=1 . "$(__koopa_header)" || return 1
    _koopa_activate_xdg || return 1
    _koopa_activate_standard_paths || return 1
    _koopa_activate_pkg_config || return 1
    _koopa_add_config_link "$(_koopa_prefix)" 'home' || return 1
    _koopa_add_config_link "$(_koopa_prefix)/activate" || return 1
    _koopa_add_config_link "$(_koopa_dotfiles_prefix)" || return 1
    _koopa_export_cpu_count || return 1
    _koopa_export_editor || return 1
    _koopa_export_git || return 1
    _koopa_export_gnupg || return 1
    _koopa_export_history || return 1
    _koopa_export_hostname || return 1
    _koopa_export_koopa_opt_prefix || return 1
    _koopa_export_pager || return 1
    _koopa_export_python || return 1
    _koopa_export_shell || return 1
    _koopa_export_tmpdir || return 1
    _koopa_export_today || return 1
    if [ "${KOOPA_MINIMAL:-0}" -eq 0 ]
    then
        if _koopa_is_linux
        then
            _koopa_activate_bcbio || return 1
        elif _koopa_is_macos
        then
            _koopa_macos_activate_python || return 1
            _koopa_macos_activate_visual_studio_code || return 1
        fi
        _koopa_activate_homebrew || return 1
        _koopa_activate_gnu || return 1
        _koopa_activate_dircolors || return 1
        _koopa_activate_gcc_colors || return 1
        _koopa_activate_emacs || return 1
        _koopa_activate_go || return 1
        _koopa_activate_llvm || return 1
        _koopa_activate_openjdk || return 1
        _koopa_activate_aspera || return 1
        _koopa_activate_nextflow || return 1
        _koopa_activate_ruby || return 1
        _koopa_activate_rust || return 1
        _koopa_activate_perl_packages || return 1
        _koopa_activate_python_packages || return 1
        _koopa_activate_python_startup || return 1
    fi
    _koopa_activate_koopa_paths || return 1
    _koopa_activate_local_paths || return 1
    if [ "${KOOPA_MINIMAL:-0}" -eq 0 ]
    then
        case "${KOOPA_SHELL:?}" in
            bash|dash|zsh)
                "_koopa_activate_${KOOPA_SHELL:?}_extras"
                ;;
        esac
        if _koopa_is_macos
        then
            _koopa_macos_activate_color_mode || return 1
            _koopa_macos_activate_iterm || return 1
            _koopa_macos_activate_cli_colors || return 1
        fi
        _koopa_activate_completion || return 1
        _koopa_activate_aliases || return 1
        _koopa_activate_secrets || return 1
        _koopa_activate_ssh_key || return 1
        if ! _koopa_is_subshell
        then
            _koopa_today_bucket || return 1
            _koopa_tmux_sessions || return 1
        fi
    fi
    if [ "${KOOPA_TEST:-0}" -eq 1 ]
    then
        set +o errexit
        set +o nounset
        # > set +o xtrace
        if [ "${KOOPA_SHELL:?}" = 'bash' ]
        then
            set +o errtrace
            set +o pipefail
        fi
        _koopa_alert_info 'Shell options'
        set +o
        _koopa_alert_info 'Shell variables'
        _koopa_dl \
            '-' "$-" \
            '0' "$0" \
            'SHELL' "${SHELL:-}"
        if _koopa_is_installed locale
        then
            _koopa_alert_info 'Locale'
            locale
        fi
        __koopa_duration_stop || return 1
        if [ -n "${KOOPA_DURATION:-}" ]
        then
            _koopa_dl 'duration' "${KOOPA_DURATION:?} ms"
        fi
        _koopa_alert_success 'Activation was successful.'
    fi
    unset -v KOOPA_ACTIVATE KOOPA_ACTIVATE_SCRIPT KOOPA_INTERACTIVE
    return 0
}

_koopa_activate "$@"
