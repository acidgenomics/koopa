#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

_koopa_assert_has_no_args "$@"
_koopa_assert_has_no_envs
_koopa_assert_is_installed rustup-init
_koopa_assert_is_not_installed rustc rustup

_koopa_message "Installing Rust via rustup-init (Homebrew)."

CARGO_HOME="$(_koopa_rust_cargo_prefix)"
export CARGO_HOME

RUSTUP_HOME="$(_koopa_rust_rustup_prefix)"
export RUSTUP_HOME

_koopa_message "CARGO_HOME: '${CARGO_HOME}'."
_koopa_message "RUSTUP_HOME: '${RUSTUP_HOME}'."

_koopa_prefix_mkdir "$CARGO_HOME"
_koopa_prefix_mkdir "$RUSTUP_HOME"

# > _koopa_set_permissions_user "$CARGO_HOME"
# > _koopa_set_permissions_user "$RUSTUP_HOME"

# error: failed to set permissions for '/usr/local/rust/cargo/bin/rustup'
rustup-init -v -y --no-modify-path

_koopa_set_permissions "$CARGO_HOME"
_koopa_set_permissions "$RUSTUP_HOME"

_koopa_success "Installation of Rust was successful."
_koopa_note "Restart the shell to finish activation."
