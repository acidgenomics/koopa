#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

# """
# Install XQuartz 2.7.9 manually instead of using xquartz cask.
#
# LLVM takes up 4 GB of disk space but is required for some Python packages.
# In particular, if we want to install umap-learn, this is now required.

# Use osgeo-gdal instead of regular gdal.
# This gets updated more regularly.

# Just use the 'install-rust' script instead of Homebrew 'rustup-init'.
#
# I hit some permissions issues with the 'rustup' cellar symlink installed at
# '/usr/local/bin/rustup' that doesn't occur when running the official script.
#
# And be sure not to install 'rust' alongside 'rustup-init'.
# """

_koopa_h1 "Installing Homebrew recipes."

_koopa_assert_has_no_args "$@"
_koopa_assert_is_installed brew

export HOMEBREW_FORCE_BOTTLE=1

# Taps                                                                      {{{1
# ==============================================================================

_koopa_h2 "Updating taps."
brew tap mongodb/brew
brew tap osgeo/osgeo4mac

# Casks                                                                     {{{1
# ==============================================================================

_koopa_h2 "Installing casks."

brew cask remove --force safari-technology-preview 

installed_casks="$(brew cask list)"

casks=(
    adoptopenjdk  # igv
    alacritty
    calibre
    carbon-copy-cloner
    docker
    java
    julia
    little-snitch
    omnidisksweeper
    osxfuse
    rstudio
)
for cask in "${casks[@]}"
do
    if echo "$installed_casks" | grep -Eq "^${cask}$"
    then
        _koopa_note "'${cask}' is already installed."
        continue
    fi
    brew cask install --force --no-quarantine "$cask"
done

casks=(
    1password
    alfred
    aspera-connect
    authy
    basictex
    bbedit
    bibdesk
    coconutbattery
    coda
    deluge
    emacs
    fiji
    firefox
    github
    google-chrome
    google-cloud-sdk
    google-drive-file-stream
    gpg-suite
    hazel
    igv
    iterm2
    keka
    kid3
    kitty
    libreoffice
    makemkv
    museeks
    netnewswire
    onyx
    photosweeper-x
    r
    scrivener
    skype
    spillo
    sublime-text
    superduper
    textmate
    tiny-player
    torbrowser
    tower
    transmit
    tunnelblick
    visual-studio-code
    vlc
    wine-stable
    xld
)
for cask in "${casks[@]}"
do
    if echo "$installed_casks" | grep -Eq "^${cask}$"
    then
        _koopa_note "'${cask}' is already installed."
        continue
    fi
    brew cask install --force "$cask"
done

# Brews                                                                     {{{1
# ==============================================================================

_koopa_h2 "Installing brews."

# This is needed currently to install R sf package from source.
brew remove --force osgeo-gdal
brew remove --force osgeo-hdf4
brew remove --force osgeo-libgeotiff
brew remove --force osgeo-libkml
brew remove --force osgeo-libspatialite
brew remove --force osgeo-netcdf
brew remove --force osgeo-postgresql
brew remove --force osgeo-proj

# Use rustup / cargo to manage these Rust packages instead:
brew remove --force broot
brew remove --force exa
brew remove --force fd
brew remove --force ripgrep
brew remove --force xsv

installed_brews="$(brew list)"
brews=(
    # Priority
    bash
    fish
    ksh
    tcsh
    zsh
    openblas
    tcl-tk
    flac
    lame
    # Alphabetical
    autoconf
    autojump
    automake
    awscli
    bash-completion
    bfg
    broot
    ccache
    circleci
    cmake
    convmv
    coreutils
    curl
    exa
    exiftool
    fd
    ffmpeg
    findutils
    flac
    fzf
    gcc
    gdal
    git
    git-lfs
    go
    gsl
    hdf5
    hub
    igraph
    imagemagick
    ksh
    leiningen
    lesspipe
    libav
    libgit2
    libiconv
    libomp
    libressl
    librsvg
    libssh2
    libxml2
    libxslt
    llvm
    mariadb-connector-c
    mas
    mongodb-community
    neofetch
    neovim
    node
    open-mpi
    openblas
    pandoc
    pandoc-citeproc
    pandoc-crossref
    parallel
    pkg-config
    podofo
    proj
    protobuf
    pyenv
    python
    python@2
    rbenv
    ripgrep
    rsync
    ruby-build
    screen
    shellcheck
    shellharden
    sox
    sqlite
    sshfs
    tesseract
    the_silver_searcher  # ag
    tmux
    trash
    tree
    udunits
    v8
    vim
    wget
    youtube-dl
    zlib
    # External
    vitorgalvao/tiny-scripts/cask-repair
)
for brew in "${brews[@]}"
do
    name="$(basename "$brew")"
    if echo "$installed_brews" | grep -Eq "^${name}$"
    then
        _koopa_note "'${name}' is already installed."
        continue
    fi
    brew install "$brew"
done

brew link gdal
brew link proj

brew unlink python
brew unlink python@2

_koopa_success "Installation of Homebrew recipes was successful."
