#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

# """
# Emacs is failing to compile on Ubuntu 18 LTS.
#
# Finding pointers to doc strings...
# Finding pointers to doc strings...done
# Dumping under the name emacs
# **************************************************
# Warning: Your system has a gap between BSS and the
# heap (29024367 bytes).  This usually means that exec-shield
# or something similar is in effect.  The dump may
# fail because of this.  See the section about
# exec-shield in etc/PROBLEMS for more information.
# **************************************************
# 12816512 of 33554432 static heap bytes used
# /bin/bash: line 1:  7508 Segmentation fault      (core dumped) 
#     ./temacs --batch --load loadup bootstrap
# make[1]: *** [bootstrap-emacs] Error 139
# Makefile:740: recipe for target 'bootstrap-emacs' failed
# make[1]: Leaving directory '/tmp/tmp.Os2bIejEX7/emacs/emacs-26.3/src'
# Makefile:421: recipe for target 'src' failed
# make: *** [src] Error 2
#
# Suggested flag (still not working):
# CFLAGS="-no-pie"
#
# See also:
# - https://askubuntu.com/questions/837306
# - http://debbugs.gnu.org/24682
# """

name="emacs"
version="$(_koopa_variable "$name")"
prefix="$(_koopa_cellar_prefix)/${name}/${version}"

_koopa_exit_if_dir "$prefix"

_koopa_h1 "Installing ${name} ${version} at '${prefix}'."

_koopa_assert_has_no_args "$@"
_koopa_assert_has_no_envs
_koopa_assert_is_installed tee

build="$(_koopa_make_build_string)"
jobs="$(_koopa_cpu_count)"
tmp_dir="$(_koopa_tmp_dir)/${name}"

if _koopa_is_docker
then
    _koopa_note "Applying ASLR fix for 'bootstrap-emacs' issue."
    aslr_file="/proc/sys/kernel/randomize_va_space"
    aslr_value="$(cat "$aslr_file")"
    echo "0" | sudo tee -a "$aslr_file" > /dev/null
fi

(
    _koopa_cd_tmp_dir "$tmp_dir"
    file="emacs-${version}.tar.xz"
    url="http://ftp.gnu.org/gnu/emacs/${file}"
    _koopa_download "$url"
    _koopa_extract "$file"
    cd "emacs-${version}" || exit 1
    ./configure \
        --build="$build" \
        --prefix="$prefix" \
        --with-x-toolkit="no" \
        --with-xpm="no" \
        CFLAGS=-no-pie
    make --jobs="$jobs"
    make install
)

rm -fr "$tmp_dir"

if _koopa_is_docker
then
    _koopa_note "Resetting default ASLR value."
    echo "$aslr_value" | sudo tee -a "$aslr_file" > /dev/null
fi

_koopa_link_cellar "$name" "$version"

_koopa_success "Installation of ${name} was successful."
