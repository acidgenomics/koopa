#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

_koopa_assert_has_args "$@"
_koopa_assert_is_installed bcbio_nextgen.py

while (("$#"))
do
    case "$1" in
        --build=*)
            build="${1#*=}"
            shift 1
            ;;
        --build)
            build="$2"
            shift 2
            ;;
        --indexes=*)
            indexes="${1#*=}"
            shift 1
            ;;
        --indexes)
            indexes="$2"
            shift 2
            ;;
        --organism=*)
            organism="${1#*=}"
            shift 1
            ;;
        --organism)
            organism="$2"
            shift 2
            ;;
        --release=*)
            release="${1#*=}"
            shift 1
            ;;
        --release)
            release="$2"
            shift 2
            ;;
        *)
            _koopa_invalid_arg "$1"
            ;;
    esac
done

if [[ -z "${organism:-}" ]] ||
    [[ -z "${build:-}" ]] ||
    [[ -z "${release:-}" ]]
then
    _koopa_missing_arg
fi

[[ -z "${indexes:-}" ]] && indexes="bowtie2 seq star"

# Convert string to array.
indexes=("$indexes")

# Check for valid organism input.
if ! _koopa_print "$organism" | grep -Eq "^([A-Z][a-z]+)(\s|_)([a-z]+)$"
then
    _koopa_stop "Invalid organism: '${organism}'."
fi

# Sanitize spaces into underscores.
# Use bash built-in rather than sed, when possible.
organism="${organism// /_}"

source="Ensembl"
bcbio_genome_name="${build}-${source}-${release}"

_koopa_install_start "$bcbio_genome_name"

# e.g. "Hsapiens".
bcbio_species_dir="$( \
    _koopa_print "$organism" \
        | sed -r "s/^([A-Z]).+_([a-z]+)$/\1\2/g" \
)"

tmp_dir="$(_koopa_tmp_dir)"
cores="$(_koopa_cpu_count)"

(
    _koopa_cd_tmp_dir "$tmp_dir"
    # e.g. Homo_sapiens.GRCh38.dna.primary_assembly.fa
    ensembl-fasta --organism "$organism" --build "$build" --type "dna"
    gtf="${organism}.${build}.dna.primary_assembly.fa"
    [[ ! -f "$fasta" ]] && _koopa_stop "FASTA failure."
    fasta="$(realpath "$fasta")"
    # e.g. Homo_sapiens.GRCh38.96.gtf
    ensembl-gtf --organism "$organism" --build "$build" --release "$release"
    gtf="${organism}.${build}.${release}.gtf"
    [[ ! -f "$gtf" ]] && _koopa_stop "GTF failure."
    gtf="$(realpath "$gtf")"
    bcbio_setup_genome.py \
        --name "$bcbio_species_dir" \
        --build "$bcbio_genome_name" \
        --cores "$cores" \
        --fasta "$fasta" \
        --gtf "$gtf" \
        --indexes "${indexes[@]}"
) 2>&1 | tee "$(_koopa_tmp_log_file)"

rm -fr "$tmp_dir"

_koopa_install_success "$bcbio_genome_name"
