#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

_koopa_exit_if_r_package_installed sf
_koopa_assert_is_not_file \
    /usr/bin/gdal-config \
    /usr/bin/geos-config \
    /usr/bin/proj

# How to enable versioned support, if necessary.
# > cellar_prefix="$(_koopa_cellar_prefix)"
# > gdal_version="$(_koopa_variable "gdal")"
# > gdal_prefix="${cellar_prefix}/gdal/${gdal_version}"
# > geos_version="$(_koopa_variable "geos")"
# > geos_prefix="${cellar_prefix}/geos/${geos_version}"
# > proj_version="$(_koopa_variable "proj")"
# > proj_prefix="${cellar_prefix}/proj/${proj_version}"

make_prefix="$(_koopa_make_prefix)"
gdal_prefix="$make_prefix"
geos_prefix="$make_prefix"
proj_prefix="$make_prefix"

export PKG_CONFIG_PATH="\
${gdal_prefix}/lib/pkgconfig:\
${proj_prefix}/lib/pkgconfig:\
/usr/local/lib/pkgconfig"
_koopa_dl PKG_CONFIG_PATH "$PKG_CONFIG_PATH"

_koopa_dl "gdal config" "$(pkg-config --libs gdal)"
_koopa_dl "geos config" "$(geos-config --libs)"
_koopa_dl "proj config" "$(pkg-config --libs proj)"

Rscript --vanilla -e "\
    install.packages(
        pkgs = \"sf\",
        type = \"source\",
        repos = \"https://cran.rstudio.com\",
        configure.args = paste(
            \"--with-gdal-config=${gdal_prefix}/bin/gdal-config\",
            \"--with-geos-config=${geos_prefix}/bin/geos-config\",
            \"--with-proj-data=${proj_prefix}/share/proj\",
            \"--with-proj-include=${proj_prefix}/include\",
            \"--with-proj-lib=${proj_prefix}/lib\",
            \"--with-proj-share=${proj_prefix}/share\"
        )
    )"
