#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

_koopa_assert_has_no_envs

while (("$#"))
do
    case "$1" in
        --bcbio-python=*)
            bcbio_python="${1#*=}"
            shift 1
            ;;
        --bcbio-python)
            bcbio_python="$2"
            shift 2
            ;;
        --git-dir=*)
            git_dir="${1#*=}"
            shift 1
            ;;
        --git-dir)
            git_dir="$2"
            shift 2
            ;;
        --install-dir=*)
            install_dir="${1#*=}"
            shift 1
            ;;
        --install-dir)
            install_dir="$2"
            shift 2
            ;;
        *)
            _koopa_invalid_arg "$1"
            ;;
    esac
done

# Locate bcbio git directory.
if [[ -z "${git_dir:-}" ]]
then
    git_dir="${HOME}/git/bcbio-nextgen"
fi
_koopa_assert_is_dir "$git_dir"

# Locate bcbio python.
if [[ -z "${bcbio_python:-}" ]]
then
    bcbio_python="$(_koopa_which_realpath "bcbio_python")"
fi
_koopa_assert_is_executable "$bcbio_python"

# Locate bcbio installation directory.
if [[ -z "${install_dir:-}" ]]
then
    install_dir="$(dirname "$(dirname "$(dirname "$bcbio_python")")")"
fi
_koopa_assert_is_dir "$install_dir"

_koopa_h1 "Patching bcbio installation."

cat << EOF
git_dir:
  ${git_dir}
bcbio_python:
  ${bcbio_python}
install_dir:
  ${install_dir}
EOF

timestamp="$(date "+%Y%m%d-%H%M%S")"
log_dir="${HOME}/logs/${HOSTNAME}/bcbio/"
log_file="${log_dir}/${timestamp}-patch-bcbio.log"
_koopa_h1 "Saving log to '${log_file}'."
mkdir -pv "$log_dir"

_koopa_h2 "Removing Python cache and compiled pyc files in Git repo."

find "$git_dir" -name "*.pyc" -delete
find "$git_dir" -name "__pycache__" -type d -exec rm -rv {} \;

_koopa_h2 "Removing Python installer cruft inside 'anaconda/lib/'."

rm -frv "${install_dir}/anaconda/lib/python"*"/site-packages/bcbio"*

# Install command must be run relative to our forked git repo.
# Note the use of absolute path to bcbio_python here.
(
    set -o xtrace
    cd "$git_dir" || exit 1
    rm -fr tests/test_automated_output
    _koopa_h2 "Patching installation via 'setup.py' script."
    "$bcbio_python" setup.py install 2>&1 | tee "$log_file"
) > "$(_koopa_tmp_log_file)"

_koopa_success "Patching of bcbio-nextgen was successful."
