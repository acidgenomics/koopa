#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

koopa::assert_has_no_envs

while (("$#"))
do
    case "$1" in
        --bcbio-python=*)
            bcbio_python="${1#*=}"
            shift 1
            ;;
        --bcbio-python)
            bcbio_python="$2"
            shift 2
            ;;
        --git-dir=*)
            git_dir="${1#*=}"
            shift 1
            ;;
        --git-dir)
            git_dir="$2"
            shift 2
            ;;
        --install-dir=*)
            install_dir="${1#*=}"
            shift 1
            ;;
        --install-dir)
            install_dir="$2"
            shift 2
            ;;
        *)
            koopa::invalid_arg "$1"
            ;;
    esac
done

# Locate bcbio git directory.
if [[ -z "${git_dir:-}" ]]
then
    git_dir="${HOME}/git/bcbio-nextgen"
fi
koopa::assert_is_dir "$git_dir"

# Locate bcbio python.
if [[ -z "${bcbio_python:-}" ]]
then
    bcbio_python="$(koopa::which_realpath "bcbio_python")"
fi
koopa::assert_is_executable "$bcbio_python"

# Locate bcbio installation directory.
if [[ -z "${install_dir:-}" ]]
then
    install_dir="$(dirname "$(dirname "$(dirname "$bcbio_python")")")"
fi
koopa::assert_is_dir "$install_dir"

name_fancy="bcbio-nextgen"

koopa::h1 "Patching ${name_fancy} installation."

cat << END
git_dir:
  ${git_dir}
bcbio_python:
  ${bcbio_python}
install_dir:
  ${install_dir}
END

koopa::h2 "Removing Python cache and compiled pyc files in Git repo."

find "$git_dir" -name "*.pyc" -delete
find "$git_dir" -name "__pycache__" -type d -exec rm -rv {} \;

koopa::h2 "Removing Python installer cruft inside 'anaconda/lib/'."

rm -frv "${install_dir}/anaconda/lib/python"*"/site-packages/bcbio"*

# Install command must be run relative to our forked git repo.
# Note the use of absolute path to bcbio_python here.
(
    cd "$git_dir" || exit 1
    rm -fr tests/test_automated_output
    koopa::h2 "Patching installation via 'setup.py' script."
    "$bcbio_python" setup.py install
) 2>&1 | tee "$(koopa::tmp_log_file)"

koopa::success "Patching of ${name_fancy} was successful."
