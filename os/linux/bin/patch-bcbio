#/usr/bin/env bash

# shellcheck source=/dev/null
source "$(_koopa_header linux)"

# Patch bcbio installation.
# Updated 2019-07-17.

# Locate bcbio git directory.
if [[ -z "${git_dir:-}" ]]
then
    git_dir="${HOME}/git/bcbio-nextgen"
fi

if [[ ! -d "$git_dir" ]]
then
    >&2 printf "Error: Failed to locate bcbio git.\n  %s\n" "$git_dir"
fi

# Locate bcbio installation directory.
if [[ -z "${install_dir:-}" ]]
then
    _koopa_assert_is_installed bcbio_nextgen.py
    bcbio_exe="$(command -v bcbio_nextgen.py)"
    bcbio_exe="$(realpath "$bcbio_exe")"
    install_dir="$(dirname $(dirname $(dirname "$bcbio_exe")))"
fi

if [[ ! -d "$install_dir" ]]
then
    >&2 printf "Error: Failed to locate bcbio install.\n  %s\n" "$install_dir"
fi

# Locate bcbio python.
if [[ -z "${bcbio_python:-}" ]]
then
    _koopa_assert_is_installed bcbio_python
    bcbio_python="$(command -v bcbio_python)"
    bcbio_python="$(realpath "$bcbio_python")"
fi

if [[ ! -x "$bcbio_python" ]]
then
    >&2 printf "Error: Failed to locate bcbio_python.\n"
fi

cat << EOF
Patching bcbio installation.

install_dir:
    ${install_dir}
bcbio_nextgen.py:
    ${bcbio_exe}
bcbio_python:
    ${bcbio_python}
EOF

timestamp="$(date "+%Y%m%d-%H%M%S")"
log_dir="${HOME}/logs/${HOSTNAME}/bcbio/"
log_file="${log_dir}/bcbio-patch-${timestamp}.log"
mkdir -p "$log_dir"

# Remove Python installer cruft.
# Note the asterisks here, they're important.
rm -frv "${install_dir}/anaconda/lib/python"*"/site-packages/bcbio"*

# Install command must be run relative to our forked git repo.
# Note the use of absolute path to bcbio_python here.
(
    cd "$git_dir" || exit 1
    rm -frv tests/test_automated_output
    "$bcbio_python" setup.py install 2>&1 | tee "$log_file"
)

"$bcbio_exe" --version
