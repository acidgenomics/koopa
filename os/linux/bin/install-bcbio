#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

name="bcbio"
version="stable"
app_prefix="$(koopa::app_prefix)/${name}"

while (("$#"))
do
    case "$1" in
        --prefix=*)
            prefix="${1#*=}"
            shift 1
            ;;
        --prefix)
            prefix="$2"
            shift 2
            ;;
        --version=*)
            version="${1#*=}"
            shift 1
            ;;
        --version)
            version="$2"
            shift 2
            ;;
        *)
            koopa::invalid_arg "$1"
            ;;
    esac
done

app_prefix="$(koopa::strip_trailing_slash "$app_prefix")"

if [[ "$version" == "stable" ]]
then
    current_version="$(koopa::current_bcbio_version)"
    prefix="${app_prefix}/${current_version}"
else
    prefix="${app_prefix}/${version}"
fi

koopa::exit_if_dir "$prefix"

name_fancy="bcbio-nextgen"

koopa::install_start "$name_fancy" "$prefix"
koopa::coffee_time

koopa::assert_has_no_envs

koopa::mkdir "$prefix"

install_dir="${prefix}/install"
tools_dir="${prefix}/tools"
tmp_dir="$(koopa::tmp_dir)"

(
    koopa::cd_tmp_dir "$tmp_dir"
    file="bcbio_nextgen_install.py"
    url="https://raw.github.com/bcbio/bcbio-nextgen/master/scripts/${file}"
    koopa::download "$url"
    python3 "$file" \
        "$install_dir" \
        --tooldir="$tools_dir" \
        --upgrade="$version" \
        --datatarget="rnaseq" \
        --datatarget="variation" \
        --nodata \
        --isolate
) 2>&1 | tee "$(koopa::tmp_log_file)"

# Clean up conda packages.
# > conda_exe="${install_dir}/anaconda/bin/conda"
# > conda_exe="${tools_dir}/bin/bcbio_conda"
# > "$conda_exe" clean --yes --tarballs

if [[ "$version" == "stable" ]]
then
    koopa::ln "${app_prefix}/${current_version}" "${app_prefix}/stable"
fi

koopa::set_permissions --recursive "$app_prefix"

koopa::install_success "$name_fancy"
