#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"



# Variables                                                                 {{{1
# ==============================================================================

version="stable"
prefix="$(_koopa_build_prefix)/bcbio"

log_dir="${HOME}/logs/${HOSTNAME}/bcbio"
tmp_dir="$(_koopa_tmp_dir)/bcbio"



# Usage                                                                     {{{1
# ==============================================================================

usage() {
current="$(_koopa_github_latest_release "bcbio/bcbio-nextgen")"
cat << EOF
$(_koopa_help_header)
    [--prefix="${prefix}"]
    [--version="${version}"]

Install bcbio-nextgen.

optional arguments:
    --prefix
        Target directory prefix.
        Defaults to '${prefix}'.
        On Azure, set to '/data00/bcbio/v${current}'.
    --version
        Install "stable" (recommended) or "development" release.
        For legacy versions, use bcbio-vm instead.

$(_koopa_help_args)

details:
    Only installs the RNA-seq pipeline, via '--datatarget="rnaseq"' internally.

    Current stable version: ${current}.
    Saves install log file into '${log_dir}'.

see also:
    https://bcbio-nextgen.readthedocs.io/

note:
    Bash script.
    Updated 2019-10-24.
EOF
}

_koopa_help "$@"



# Arguments                                                                 {{{1
# ==============================================================================

while (("$#"))
do
    case "$1" in
        --prefix=*)
            prefix="${1#*=}"
            shift 1
            ;;
        --prefix)
            prefix="$2"
            shift 2
            ;;
        --version=*)
            version="${1#*=}"
            shift 1
            ;;
        --version)
            version="$2"
            shift 2
            ;;
        *)
            _koopa_invalid_arg "$1"
            ;;
    esac
done

prefix="$(_koopa_strip_trailing_slash "$prefix")"


# Script                                                                    {{{1
# ==============================================================================

_koopa_assert_has_no_environments

_koopa_message "Installing bcbio '${version}' into '${prefix}'."

install_dir="${prefix}/install"
tools_dir="${prefix}/tools"

log_dir="${log_dir}/${version}"
timestamp="$(date "+%Y%m%d-%H%M%S")"
log_file="${log_dir}/bcbio-install-${version}-${timestamp}.log"
_koopa_message "Saving install log at '${log_file}"
mkdir -pv "$log_dir"

_koopa_prefix_mkdir "$prefix"

(
    rm -fr "$tmp_dir"
    mkdir -p "$tmp_dir"
    cd "$tmp_dir" || exit 1
    file="bcbio_nextgen_install.py"
    wget "https://raw.github.com/bcbio/bcbio-nextgen/master/scripts/${file}"
    python "$file"                                                             \
        "$install_dir"                                                         \
        --tooldir="$tools_dir"                                                 \
        --upgrade="$version"                                                   \
        --datatarget="rnaseq"                                                  \
        --nodata                                                               \
        --isolate                                                              \
        2>&1 | tee "$log_file"
)

# Keep install owned by current user, so we can install genomes easily.
_koopa_prefix_chgrp "$prefix"

# Here's how to set to root, otherwise:
# > _koopa_set_permissions "$prefix"

# Disable group write access to install.
# > chmod -R g-w "$install_dir" "$tools_dir"

# Fix for current macs2/numpy issue.
# https://github.com/bcbio/bcbio-nextgen/issues/2853
# > "${tools_dir}/bin/bcbio_conda" install -y --name python2 numpy
