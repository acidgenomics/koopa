#!/usr/bin/env bash
set -Eeu -o pipefail

# shellcheck source=/dev/null
source "$(_koopa_header linux)"

# Install bcbio-nextgen genomes.
# Updated 2019-06-21.

_koopa_assert_is_installed bcbio_nextgen.py

version="$(bcbio_nextgen.py --version)"
tmp_dir="$(_koopa_tmp_dir)/bcbio"

log_dir="${HOME}/logs/${HOSTNAME}/bcbio/${version}"
mkdir -p "$log_dir"
log_file="${log_dir}/upgrade-genomes-$(date "+%Y%m%d_%H%M%S").log"

cores="$((CPU_COUNT-2))"
[[ "$cores" -lt 1 ]] && cores=1

(
    rm -rf "$tmp_dir"
    mkdir -p "$tmp_dir"
    cd "$tmp_dir" || exit 1
    bcbio_nextgen.py upgrade \
        --upgrade "skip" \
        --cores "$cores" \
        --genomes "BDGP6" \
        --genomes "canFam3" \
        --genomes "hg38" \
        --genomes "hg19" \
        --genomes "mm10" \
        --genomes "rn6" \
        2>&1 | tee "$log_file"
    rm -rf "$tmp_dir"
)
