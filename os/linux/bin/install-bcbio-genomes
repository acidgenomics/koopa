#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"



# FIXME Add note regarding HISAT2 being a memory hog:
# Ran out of memory; automatically trying more memory-economical parameters.


# Variables                                                                 {{{1
# ==============================================================================

cores="$CPU_COUNT"

timestamp="$(date "+%Y%m%d_%H%M%S")"
version="$(bcbio_nextgen.py --version)"
log_dir="${HOME}/logs/${HOSTNAME}/bcbio"
log_file="${log_dir}/${timestamp}-install-bcbio-genomes-${version}.log"

tmp_dir="$(_koopa_tmp_dir)/bcbio"

genomes="BDGP6,canFam3,hg38,mm10,rn6"



# Usage                                                                     {{{1
# ==============================================================================

usage() {
cat << EOF
$(_koopa_help_header)
    [genomes="${genomes}"]

Install bcbio-nextgen genomes.

required positional arguments with defaults:
    1.  Genomes to install.
        Comma delimited string, without spaces.
        Defaults to '${genomes}'.

$(_koopa_help_args)

details:
    Installs these supported genomes by default:

    | UCSC    | organism                |
    | ------- | ----------------------- |
    | BDGP6   | Drosophila melanogaster |
    | canFam3 | Canis lupus familiaris  |
    | hg38    | Homo sapiens            |
    | mm10    | Mus musculus            |
    | rn6     | Rattus norvegicus       |

    Log file will be saved at:
    '${log_file}'

see also:
    - https://bcbio-nextgen.readthedocs.io/
    - https://github.com/bcbio/bcbio-nextgen/tree/master/config/genomes
    - https://github.com/chapmanb/cloudbiolinux/tree/master/ggd-recipes

note:
    Bash script.
    Updated 2019-10-24.
EOF
}

_koopa_help "$@"



# Arguments                                                                 {{{1
# ==============================================================================

genomes="${1:-$genomes}"
IFS=', ' read -r -a genomes <<< "$genomes"



# Script                                                                    {{{1
# ==============================================================================

_koopa_assert_is_installed bcbio_nextgen.py

bcbio_exe="$(_koopa_realpath "bcbio_nextgen.py")"
bcbio_dir="$(cd "$(dirname "$bcbio_exe")/../.." && pwd -P)"
genomes_dir="${bcbio_dir}/genomes"


_koopa_message "Installing bcbio genomes '${genomes[*]}' into '${genomes_dir}'."

genome_flags=()
for genome in "${genomes[@]}"
do
    genome_flags+=("--genomes=${genome}")
done

flags=(
    "--upgrade=skip"
    "--cores=${cores}"
    "${genome_flags[@]}"
)

mkdir -pv "$log_dir"

(
    rm -frv "$tmp_dir"
    mkdir -p "$tmp_dir"
    cd "$tmp_dir" || exit 1
    bcbio_nextgen.py upgrade "${flags[@]}" 2>&1 | tee "$log_file"
    rm -fr "$tmp_dir"
)
