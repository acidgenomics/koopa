#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

_koopa_assert_has_no_args "$@"
_koopa_assert_has_no_envs
_koopa_assert_is_not_installed rustup

# Error on detection of local cargo and/or rustup directories.
_koopa_assert_is_not_dir "${HOME}/.cargo"
_koopa_assert_is_not_dir "${HOME}/.rustup"

prefix="$(_koopa_app_prefix)/rust"
_koopa_assert_is_not_dir "$prefix"

_koopa_message "Installing Rust using rustup into '${prefix}'."

export CARGO_HOME="${prefix}/cargo"
export RUSTUP_HOME="${prefix}/rustup"

_koopa_note "CARGO_HOME: '${CARGO_HOME}'."
_koopa_note "RUSTUP_HOME: '${RUSTUP_HOME}'."

curl -sSf https://sh.rustup.rs | sh -s -- -v -y --no-modify-path

_koopa_set_permissions "$prefix"
