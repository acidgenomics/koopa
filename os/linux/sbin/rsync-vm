#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

_koopa_assert_has_args "$@"

# Argument parsing  {{{1
# ==============================================================================

while (("$#"))
do
    case "$1" in
        --source-ip=*)
            source_ip="${1#*=}"
            shift 1
            ;;
        --source-ip)
            source_ip="$2"
            shift 2
            ;;
        *)
            _koopa_invalid_arg "$1"
            ;;
    esac
done

if [[ -z "${source_ip:-}" ]]
then
    _koopa_missing_arg
fi

# Source check  {{{1
# ==============================================================================

# Ensure that source and local (host) IP addresses are not identical. If they
# are, early exit without error, as this script is called inside 'configure-vm'.
host_ip="$(_koopa_local_ip_address)"
if [[ "$source_ip" == "$host_ip" ]]
then
    _koopa_exit "Skipping rsync because '${host_ip}' is source machine."
fi

# app prefix  {{{1
# ==============================================================================

# Need to sync this before make prefix step, otherwise some symlinks won't
# resolve as expected, and chmod will error.

app_prefix="$(_koopa_app_prefix)"

if [[ -d "$app_prefix" ]]
then
    # Skipping programs that are specific to powerful multi-core VMs.
    mapfile -t app_flags <<< "$(_koopa_rsync_flags)"
    if ! _koopa_is_powerful
    then
        app_flags+=(
            # "--exclude=bcbio"
            "--exclude=cellranger"
            "--exclude=cellranger-atac"
            "--exclude=omicsoft"
        )
    fi
    _koopa_rsync_vm \
        --flags="${app_flags[*]}" \
        --prefix="$app_prefix" \
        --source-ip="$source_ip"
else
    _koopa_note "Skipping '${app_prefix}'."
fi

# make prefix  {{{1
# ==============================================================================

make_prefix="$(_koopa_make_prefix)"
_koopa_rsync_vm \
    --prefix="$make_prefix" \
    --source-ip="$source_ip"

# refdata prefix {{{1
# ==============================================================================

refdata_prefix="$(_koopa_refdata_prefix)"

if [[ -d "$refdata_prefix" ]]
then
    # Skipping references that are specific to powerful multi-core VMs.
    mapfile -t refdata_flags <<< "$(_koopa_rsync_flags)"
    if ! _koopa_is_powerful
    then
        refdata_flags+=(
            "--exclude=bcbio"
            "--exclude=cellranger"
            "--exclude=cellranger-atac"
            "--exclude=gtex"
        )
    fi
    _koopa_rsync_vm \
        --flags="${refdata_flags[*]}" \
        --prefix="$refdata_prefix" \
        --source-ip="$source_ip"
else
    _koopa_note "Skipping '${refdata_prefix}'."
fi
