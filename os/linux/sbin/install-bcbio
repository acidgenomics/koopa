#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"
_koopa_assert_has_no_envs

prefix="$(_koopa_make_prefix)/bcbio"
version="stable"

tmp_dir="$(_koopa_tmp_dir)/bcbio"

timestamp="$(date "+%Y%m%d-%H%M%S")"
log_dir="${HOME}/logs/${HOSTNAME}/bcbio"
log_file="${log_dir}/${timestamp}-install-bcbio.log"

while (("$#"))
do
    case "$1" in
        --prefix=*)
            prefix="${1#*=}"
            shift 1
            ;;
        --prefix)
            prefix="$2"
            shift 2
            ;;
        --version=*)
            version="${1#*=}"
            shift 1
            ;;
        --version)
            version="$2"
            shift 2
            ;;
        *)
            _koopa_invalid_arg "$1"
            ;;
    esac
done

prefix="$(_koopa_strip_trailing_slash "$prefix")"

if [[ "$version" == "stable" ]]
then
    # > current="$(_koopa_github_latest_release "bcbio/bcbio-nextgen")"
    _koopa_bcbio_version() {
        curl --silent "https://raw.githubusercontent.com/bcbio/bcbio-nextgen\
/master/requirements-conda.txt" \
            | grep 'bcbio-nextgen=' \
            | cut -d '=' -f 2
    }
    current="$(_koopa_bcbio_version)"
    prefix="${prefix}/${current}"
else
    prefix="${prefix}/${version}"
fi

_koopa_assert_is_not_dir "$prefix"

_koopa_message "Installing bcbio into '${prefix}'."

_koopa_message "Saving install log at '${log_file}'."
mkdir -pv "$log_dir"

_koopa_prefix_mkdir "$prefix"
install_dir="${prefix}/install"
tools_dir="${prefix}/tools"

(
    _koopa_cd_tmp_dir "$tmp_dir"
    file="bcbio_nextgen_install.py"
    url="https://raw.github.com/bcbio/bcbio-nextgen/master/scripts/${file}"
    _koopa_download "$url"
    python "$file" \
        "$install_dir" \
        --tooldir="$tools_dir" \
        --upgrade="$version" \
        --datatarget="rnaseq" \
        --datatarget="variation" \
        --nodata \
        --isolate \
        2>&1 | tee "$log_file"
)

# > _koopa_message "Fixing MACS2/numpy issue."
# > _koopa_note "https://github.com/bcbio/bcbio-nextgen/issues/2853"
# > "${tools_dir}/bin/bcbio_conda" install -y --name python2 numpy

# Keep install owned by current user, so we can install genomes easily.
_koopa_prefix_chgrp "$prefix"

# Here's how to set to root, otherwise:
# > _koopa_set_permissions "$prefix"

# Disable group write access to install.
# > chmod -R g-w "$install_dir" "$tools_dir"

