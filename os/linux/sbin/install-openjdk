#!/usr/bin/env bash

# https://openjdk.java.net/
# https://jdk.java.net/13/

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

_koopa_assert_has_sudo

jdk_dir="${1:-"/opt/jdk"}"

version="$(_koopa_variable "java")"
jdk_version_dir="${jdk_dir}/jdk-${version}"
# > _koopa_assert_is_not_dir "$jdk_version_dir"

_koopa_message "Installing JDK ${version} at '${jdk_version_dir}'."

if [[ ! -d "$jdk_dir" ]]
then
    _koopa_prefix_mkdir "$jdk_dir"
fi

# Download and extract the JDK, if necessary.
if [[ ! -d "$jdk_version_dir" ]]
then
    (
        cd "${jdk_dir}" || exit 1
        file="openjdk-${version}_linux-x64_bin.tar.gz"
        case "$version" in
            13.0.1)
                unique="cec27d702aa74d5a8630c65ae61e4305/9"
                ;;
            13)
                unique="5b8a42f3905b406298b72d750b6919f6/33"
                ;;
        esac
        url="https://download.java.net/java/GA/jdk${version}/${unique}/GPL/${file}"
        _koopa_download "$url"
        _koopa_message "Extracting '${file}' to '${jdk_dir}'."
        tar -xzvf "$file" -C "$jdk_dir"
    )
fi

_koopa_set_permissions "$jdk_dir"

priority="100"

sudo rm -fv /var/lib/alternatives/java
sudo update-alternatives --install \
    "/usr/bin/java" \
    "java" \
    "${jdk_dir}/jdk-${version}/bin/java" \
    "$priority"

sudo rm -fv /var/lib/alternatives/javac
sudo update-alternatives --install \
    "/usr/bin/javac" \
    "javac" \
    "${jdk_dir}/jdk-${version}/bin/javac" \
    "$priority"

sudo rm -fv /var/lib/alternatives/jar
sudo update-alternatives --install \
    "/usr/bin/jar" \
    "jar" \
    "${jdk_dir}/jdk-${version}/bin/jar" \
    "$priority"

sudo update-alternatives --config java
sudo update-alternatives --config javac
sudo update-alternatives --config jar

update-alternatives --display java
update-alternatives --display javac
update-alternatives --display jar

java --version

# Update rJava configuration.
if _koopa_is_installed R
then
    r-javareconf
fi
