#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

version=

while (("$#"))
do
    case "$1" in
        --version=*)
            version="${1#*=}"
            shift 1
            ;;
        --version)
            version="$2"
            shift 2
            ;;
        *)
            koopa::invalid_arg "$1"
            ;;
    esac
done

name="lmod"
[[ -z "$version" ]] && version="$(koopa::variable "$name")"
prefix="$(koopa::app_prefix)/${name}"
koopa::exit_if_dir "$prefix"

name_fancy="Lmod"
koopa::install_start "$name_fancy" "$version" "$prefix"

koopa::assert_has_no_args "$#"
koopa::assert_has_no_envs
koopa::assert_is_installed lua luarocks

apps_dir="${prefix}/apps"
data_dir="${prefix}/moduleData"
tmp_dir="$(koopa::tmp_dir)"

# Install luarocks dependencies.
eval "$(luarocks path)"
luarocks install luaposix
luarocks install luafilesystem

(
    koopa::cd "$tmp_dir"
    file="${version}.tar.gz"
    url="https://github.com/TACC/Lmod/archive/${file}"
    koopa::download "$url"
    koopa::extract "$file"
    cd "Lmod-${version}" || exit 1
    ./configure \
        --prefix="$apps_dir" \
        --with-spiderCacheDir="${data_dir}/cacheDir" \
        --with-updateSystemFn="${data_dir}/system.txt"
    sudo make install
    rm -fr "$tmp_dir"
) 2>&1 | tee "$(koopa::tmp_log_file)"

koopa::update_lmod_config

koopa::install_success "$name_fancy"
