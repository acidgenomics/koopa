#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

# """
# Install R using 'install-r' script instead, which sets up apt to support
# newer official release from CRAN.
#
#
# Clean up previous:
# - openjdk-12-jdk
# - openjdk-12-jre
# - python
#
#
# Bioconductor AMI is missing these dependencies:
# > apt-cache search 'libgnutls.*-dev'
# > apt-cache search gnutls
# > apt-cache search libgif
#
# 'libcurl4-gnutls-dev' gets installed by 'git' above.
#
# Conflicts:
# libcurl4-gnutls-dev
# libcurl4-openssl-dev
#
#
# Note that 'golang-go' is not officially supported.
# """

_koopa_h2 "Installing Debian base system."

_koopa_assert_has_no_args "$@"
_koopa_assert_is_installed sed sudo

export DEBIAN_FRONTEND="noninteractive"

# Debian symlinks '/usr/local/man' to '/usr/local/share/man' by default, which
# is non-standard and can cause cellar link script to break.
if [[ -L /usr/local/man ]]
then
    sudo rm -v /usr/local/man
fi

# Enable Debian sources.
# To use 'build-dep', you must uncomment deb-src lines:
# > sudo vim /etc/apt/sources.list
#
# Otherwise you'll hit this error:
# You must put some 'source' URIs in your sources.list
#
# https://askubuntu.com/questions/496549

if grep -Eq '^# deb-src ' /etc/apt/sources.list
then
    _koopa_h2 "Enabling Debian sources for 'build-dep'."
    sudo cp -fv /etc/apt/sources.list /etc/apt/sources.list~
    sudo sed -Ei 's/^# deb-src /deb-src /' /etc/apt/sources.list
fi

sudo apt-get update

_koopa_h2 "Upgrading install via 'apt-get dist-upgrade'."
sudo DEBIAN_FRONTEND=noninteractive \
    apt-get \
        --fix-missing \
        --no-install-recommends \
        --quiet \
        --yes \
        dist-upgrade

_koopa_h2 "Installing recommending packages."
pkgs=(
    autoconf                                                        #      23 MB
    automake                                                        #      21 MB
    bc                                                              #      26 MB
    ca-certificates                                                 #     249 MB
    cmake                                                           #      25 MB
    coreutils                                                       #         NA
    curl                                                            #     < 1 MB
    dirmngr                                                         #       4 MB
    findutils                                                       #         NA
    gcc                                                             #     333 MB
    gdb                                                             #      51 MB
    gdebi-core                                                      #     < 1 MB
    gfortran                                                        #     < 1 MB
    git                                                             #      34 MB
    gnupg                                                           #       2 MB
    gnutls-bin                                                      #       1 MB
    gpg-agent                                                       #       4 MB
    htop                                                            #     < 1 MB
    less                                                            #     < 1 MB
    libacl1-dev                                                     #     < 1 MB
    libbz2-dev                                                      #      36 MB
    libcairo2-dev                                                   #      94 MB
    libcurl4-openssl-dev                                            #     < 1 MB
    libevent-dev                                                    #       2 MB
    libffi-dev                                                      #     188 MB
    libfreetype6-dev                                                #      98 MB
    libgdal-dev                                                     #
    libgif-dev                                                      #
    libglu1-mesa-dev                                                #
    libgnutls28-dev                                                 #
    libgsl-dev                                                      #
    libharfbuzz-dev                                                 #
    libhdf5-dev                                                     #
    liblzma-dev                                                     #
    libmagick++-dev                                                 #
    libmariadb-dev                                                  #
    libncurses-dev                                                  #
    libopenblas-base                                                #
    libopenblas-dev                                                 #
    libpng-dev                                                      #
    libssh2-1-dev                                                   #
    libssl-dev                                                      #
    libtool                                                         #
    libtool-bin                                                     #
    libudunits2-dev                                                 #
    libv8-dev                                                       #
    libx11-dev                                                      #
    libxml2-dev                                                     #
    libz-dev                                                        #
    lsb-release                                                     #
    nano                                                            #
    parallel                                                        #
    pkg-config                                                      #
    software-properties-common                                      #
    sudo                                                            #
    tree                                                            #
    tzdata                                                          #
    wget                                                            #
)
sudo DEBIAN_FRONTEND=noninteractive \
    apt-get \
        --fix-missing \
        --no-install-recommends \
        --quiet \
        --yes \
        install "${pkgs[@]}"

pkgs=(
    alien                                                           #
    apt-listchanges                                                 #
    apt-utils                                                       #
    cargo                                                           # 9782 kB
    emacs                                                           #     113 MB
    firefox                                                         # 202 MB
    fish                                                            # 3824 kB
    gtk-doc-tools                                                   #    5876 kB
    keyboard-configuration                                          # 2636 kB
    pandoc                                                          # 116 MB
    pandoc-citeproc                                                 # 97.3 MB
    perl                                                            # 582 kB
    sqlite3                                                         # 2481 kB
    systemd                                                         # 13.8 MB
    texlive                                                         # 70.7 kB
    tmux                                                            #
    unattended-upgrades                                             # 306 kB
    vim                                                             #    32.0 MB
    xorg                                                            #    29.6 MB
    zsh                                                             #    15.3 MB
)
! _koopa_is_docker && sudo DEBIAN_FRONTEND=noninteractive \
    apt-get \
        --fix-missing \
        --no-install-recommends \
        --quiet \
        --yes \
        install "${pkgs[@]}"

if grep -Eq '^# deb-src ' /etc/apt/sources.list
then
    _koopa_h2 "Installing recommended dependencies via 'apt-get build-dep'."
    sudo apt-get update
    # Including 'bash' here will remove 'r-base'.
    sudo DEBIAN_FRONTEND=noninteractive \
        apt-get \
            --no-install-recommends \
            --quiet \
            --yes \
            build-dep \
                coreutils \
                git \
                htop \
                perl \
                tmux \
                vim \
                zsh
    ! _koopa_is_docker && \
        sudo DEBIAN_FRONTEND=noninteractive \
            apt-get \
                --no-install-recommends \
                --quiet \
                --yes \
                build-dep \
                    emacs-defaults \
                    fish \
                    neovim
fi

_koopa_h2 "Removing unused packages via 'apt-get autoremove'."
sudo apt-get --yes autoremove

sudo rm -fr /var/lib/apt/lists/*
