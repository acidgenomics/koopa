#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

# """
# Install R using 'install-r' script instead, which sets up apt to support
# newer official release from CRAN.
#
#
# Clean up previous:
# - openjdk-12-jdk
# - openjdk-12-jre
# - python
#
#
# Bioconductor AMI is missing these dependencies:
# > apt-cache search 'libgnutls.*-dev'
# > apt-cache search gnutls
# > apt-cache search libgif
#
# 'libcurl4-gnutls-dev' gets installed by 'git' above.
#
# Conflicts:
# libcurl4-gnutls-dev
# libcurl4-openssl-dev
#
#
# Note that 'golang-go' is not officially supported.
# """

_koopa_h2 "Installing Debian base system."

_koopa_assert_has_no_args "$@"
_koopa_assert_is_installed sed sudo

export DEBIAN_FRONTEND="noninteractive"

# Debian symlinks '/usr/local/man' to '/usr/local/share/man' by default, which
# is non-standard and can cause cellar link script to break.
if [[ -L /usr/local/man ]]
then
    sudo rm -v /usr/local/man
fi

# Enable Debian sources.
# To use 'build-dep', you must uncomment deb-src lines:
# > sudo vim /etc/apt/sources.list
#
# Otherwise you'll hit this error:
# You must put some 'source' URIs in your sources.list
#
# https://askubuntu.com/questions/496549

if grep -Eq '^# deb-src ' /etc/apt/sources.list
then
    _koopa_h2 "Enabling Debian sources for 'build-dep'."
    sudo cp -fv /etc/apt/sources.list /etc/apt/sources.list~
    sudo sed -Ei 's/^# deb-src /deb-src /' /etc/apt/sources.list
fi

sudo apt-get update

_koopa_h2 "Upgrading install via 'apt-get dist-upgrade'."
sudo DEBIAN_FRONTEND=noninteractive \
    apt-get \
        --fix-missing \
        --no-install-recommends \
        --quiet \
        --yes \
        dist-upgrade

_koopa_h2 "Installing recommending packages."
                                                   # |   w/o deps |    w/ deps |
pkgs=(                                             # | ---------- | ---------- |
    apt-listchanges                                # |            |     < 1 MB |
    apt-utils                                      # |            |     < 1 MB |
    autoconf                                       # |       1 MB |      23 MB |
    automake                                       # |            |      21 MB |
    bc                                             # |            |      26 MB |
    ca-certificates                                # |            |         NA |
    cmake                                          # |            |      25 MB |
    coreutils                                      # |            |         NA |
    curl                                           # |            |     < 1 MB |
    dirmngr                                        # |            |       4 MB |
    findutils                                      # |            |         NA |
    gcc                                            # |         NA |         NA |
    gdb                                            # |       9 MB |      51 MB |
    gdebi-core                                     # |            |     < 1 MB |
    gfortran                                       # |            |     < 1 MB |
    git                                            # |      32 MB |      34 MB |
    gnupg                                          # |            |       2 MB |
    gnutls-bin                                     # |            |       1 MB |
    gpg-agent                                      # |            |       4 MB |
    htop                                           # |            |     < 1 MB |
    less                                           # |            |     < 1 MB |
    lsb-release                                    # |            |         NA |
    nano                                           # |            |     < 1 MB |
    parallel                                       # |            |       2 MB |
    pkg-config                                     # |            |         NA |
    sudo                                           # |            |         NA |
    tmux                                           # |            |       1 MB |
    tree                                           # |            |     < 1 MB |
    tzdata                                         # |            |         NA |
    vim                                            # |       3 MB |      32 MB |
    wget                                           # |            |       1 MB |
)
sudo DEBIAN_FRONTEND=noninteractive \
    apt-get \
        --fix-missing \
        --no-install-recommends \
        --quiet \
        --yes \
        install "${pkgs[@]}"
                                                   # |   w/o deps |    w/ deps |
pkgs=(                                             # | ---------- | ---------- |
    # cargo                                        # |      12 MB |     308 MB |
    alien                                          # |            |       2 MB |
    emacs                                          # |       8 MB |     112 MB |
    firefox                                        # |            |     203 MB |
    fish                                           # |            |      10 MB |
    gtk-doc-tools                                  # |            |       9 MB |
    keyboard-configuration                         # |            |      35 MB |
    libacl1-dev                                    # |            |     < 1 MB |
    libbz2-dev                                     # |            |      36 MB |
    libcairo2-dev                                  # |            |      94 MB |
    libcurl4-openssl-dev                           # |            |     < 1 MB |
    libevent-dev                                   # |            |       2 MB |
    libffi-dev                                     # |            |     188 MB |
    libfreetype6-dev                               # |            |      98 MB |
    libgdal-dev                                    # |            |     298 MB |
    libgif-dev                                     # |            |     289 MB |
    libglu1-mesa-dev                               # |            |       1 MB |
    libgnutls28-dev                                # |            |       8 MB |
    libgsl-dev                                     # |            |       9 MB |
    libharfbuzz-dev                                # |            |     436 MB |
    libhdf5-dev                                    # |            |     306 MB |
    liblzma-dev                                    # |            |     340 MB |
    libmagick++-dev                                # |            |    35.9 MB |
    libmariadb-dev                                 # |            |       1 MB |
    libncurses-dev                                 # |            |       1 MB |
    libopenblas-base                               # |            |    94.8 MB |
    libopenblas-dev                                # |            |    53.4 MB |
    libpng-dev                                     # |            |     402 MB |
    libssh2-1-dev                                  # |            |       3 MB |
    libssl-dev                                     # |            |     297 MB |
    libtool                                        # |            |      21 MB |
    libtool-bin                                    # |            |     < 1 MB |
    libudunits2-dev                                # |            |       1 MB |
    libv8-dev                                      # |            |       5 MB |
    libx11-dev                                     # |            |     109 MB |
    libxml2-dev                                    # |            |     330 MB |
    libz-dev                                       # |            |         NA |
    pandoc                                         # |            |      53 MB |
    pandoc-citeproc                                # |            |      47 MB |
    perl                                           # |            |     987 MB |
    software-properties-common                     # |            |     < 1 MB |
    sqlite3                                        # |            |       2 MB |
    systemd                                        # |            |         NA |
    texlive                                        # |            |     < 1 MB |
    unattended-upgrades                            # |            |     < 1 MB |
    xorg                                           # |            |      30 MB |
    zsh                                            # |            |      15 MB |
)
! _koopa_is_docker && sudo DEBIAN_FRONTEND=noninteractive \
    apt-get \
        --fix-missing \
        --no-install-recommends \
        --quiet \
        --yes \
        install "${pkgs[@]}"

if ! _koopa_is_docker && \
    grep -Eq '^deb-src ' /etc/apt/sources.list
then
    _koopa_h2 "Installing recommended dependencies via 'apt-get build-dep'."
    sudo apt-get update
    # Including 'bash' here will remove 'r-base'.
    deps=(
        coreutils
        emacs-defaults
        fish
        git
        htop
        neovim
        perl
        tmux
        vim
        zsh
    )
    sudo DEBIAN_FRONTEND=noninteractive \
        apt-get \
            --no-install-recommends \
            --quiet \
            --yes \
            build-dep "${deps[@]}"
fi

_koopa_h2 "Removing unused packages via 'apt-get autoremove'."
sudo apt-get --yes autoremove

sudo rm -fr /root/.cache/*
sudo rm -fr /var/lib/apt/lists/*
