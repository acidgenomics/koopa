#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

# """
# Install R using 'install-r' script instead, which sets up apt to support
# newer official release from CRAN.
#
# Clean up previous:
# - openjdk-12-jdk
# - openjdk-12-jre
# - python
#
# Bioconductor AMI is missing these dependencies:
# > apt-cache search 'libgnutls.*-dev'
# > apt-cache search gnutls
# > apt-cache search libgif
#
# 'libcurl4-gnutls-dev' gets installed by 'git' above.
#
# Conflicts:
# libcurl4-gnutls-dev
# libcurl4-openssl-dev
#
# Note that 'golang-go' is not officially supported.
# """

_koopa_assert_has_no_args "$@"

export DEBIAN_FRONTEND="noninteractive"

# Debian symlinks '/usr/local/man' to '/usr/local/share/man' by default, which
# is non-standard and can cause cellar link script to break.
if [[ -L /usr/local/man ]]
then
    sudo rm -v /usr/local/man
fi

# Enable Debian sources.
# To use 'build-dep', you must uncomment deb-src lines:
# > sudo vim /etc/apt/sources.list
#
# Otherwise you'll hit this error:
# You must put some 'source' URIs in your sources.list
#
# https://askubuntu.com/questions/496549
if [[ ! -f /etc/apt/sources.list~ ]]
then
    echo "Enabling Debian sources for 'build-dep'."
    sudo cp /etc/apt/sources.list /etc/apt/sources.list~
    sudo sed -Ei 's/^# deb-src /deb-src /' /etc/apt/sources.list
fi

sudo apt-get update
sudo DEBIAN_FRONTEND=noninteractive \
    apt-get -y dist-upgrade

# Including 'bash' here will remove 'r-base'.
sudo DEBIAN_FRONTEND=noninteractive \
    apt-get -y build-dep \
        coreutils \
        emacs-defaults \
        fish \
        git \
        htop \
        neovim \
        perl \
        tmux \
        vim \
        zsh

sudo DEBIAN_FRONTEND=noninteractive \
    apt-get -y install \
        alien \
        autoconf \
        automake \
        cargo \
        cmake \
        emacs \
        firefox \
        fish \
        gdebi-core \
        git \
        gnupg2 \
        gnutls-bin \
        gtk-doc-tools \
        htop \
        libacl1 \
        libacl1-dev \
        libbz2-dev \
        libcairo2-dev \
        libevent-dev \
        libffi-dev \
        libfreetype6-dev \
        libgdal-dev \
        libgif-dev \
        libglu1-mesa-dev \
        libgnutls28-dev \
        libgsl-dev \
        libharfbuzz-dev \
        libhdf5-dev \
        liblzma-dev \
        libmagick++-dev \
        libmariadb-client-lgpl-dev \
        libopenblas-base \
        libopenblas-dev \
        libpng-dev \
        libssh2-1-dev \
        libssl-dev \
        libtool \
        libtool-bin \
        libudunits2-dev \
        libv8-dev \
        libx11-dev \
        libxml2-dev \
        libz-dev \
        keyboard-configuration \
        pandoc \
        pandoc-citeproc \
        parallel \
        perl \
        pkg-config \
        python3 \
        python3-pip \
        sqlite3 \
        systemd \
        texlive \
        tree \
        tmux \
        tzdata \
        vim \
        xorg \
        zsh

sudo apt-get -y autoremove

if ! _koopa_is_docker
then
    install-docker
fi

install-r
install-llvm
