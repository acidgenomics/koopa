#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

# """
# Install R using 'install-r' script instead, which sets up apt to support
# newer official release from CRAN.
#
# Clean up previous:
# - openjdk-12-jdk
# - openjdk-12-jre
# - python
#
# Bioconductor AMI is missing these dependencies:
# > apt-cache search 'libgnutls.*-dev'
# > apt-cache search gnutls
# > apt-cache search libgif
#
# 'libcurl4-gnutls-dev' gets installed by 'git' above.
#
# Conflicts:
# libcurl4-gnutls-dev
# libcurl4-openssl-dev
#
# Note that 'golang-go' is not officially supported.
# """

_koopa_h2 "Installing Debian base system."

_koopa_assert_has_no_args "$@"
_koopa_assert_is_installed sed sudo

export DEBIAN_FRONTEND="noninteractive"

# Debian symlinks '/usr/local/man' to '/usr/local/share/man' by default, which
# is non-standard and can cause cellar link script to break.
if [[ -L /usr/local/man ]]
then
    sudo rm -v /usr/local/man
fi

# Enable Debian sources.
# To use 'build-dep', you must uncomment deb-src lines:
# > sudo vim /etc/apt/sources.list
#
# Otherwise you'll hit this error:
# You must put some 'source' URIs in your sources.list
#
# https://askubuntu.com/questions/496549
if [[ ! -f /etc/apt/sources.list~ ]]
then
    _koopa_h2 "Enabling Debian sources for 'build-dep'."
    sudo cp /etc/apt/sources.list /etc/apt/sources.list~
    sudo sed -Ei 's/^# deb-src /deb-src /' /etc/apt/sources.list
fi

sudo apt-get update

_koopa_h2 "Upgrading install via 'apt-get dist-upgrade'."
sudo DEBIAN_FRONTEND=noninteractive \
    apt-get \
        --fix-missing \
        --no-install-recommends \
        --yes \
        dist-upgrade

_koopa_h2 "Installing recommending packages."
sudo DEBIAN_FRONTEND=noninteractive \
    apt-get \
        --fix-missing \
        --no-install-recommends \
        --yes \
        install \
            alien \
            apt-listchanges \
            apt-utils \
            autoconf \
            automake \
            bc \
            ca-certificates \
            cargo \
            cmake \
            coreutils \
            curl \
            dirmngr \
            emacs \
            findutils \
            gcc \
            gdb \
            gdebi-core \
            gfortran \
            git \
            gnupg \
            gnutls-bin \
            gpg-agent \
            gtk-doc-tools \
            keyboard-configuration \
            less \
            libacl1 \
            libacl1-dev \
            libbz2-dev \
            libcairo2-dev \
            libcurl4-openssl-dev \
            libevent-dev \
            libffi-dev \
            libfreetype6-dev \
            libgdal-dev \
            libgif-dev \
            libglu1-mesa-dev \
            libgnutls28-dev \
            libgsl-dev \
            libharfbuzz-dev \
            libhdf5-dev \
            liblzma-dev \
            libmagick++-dev \
            libmariadb-dev \
            libopenblas-base \
            libopenblas-dev \
            libpng-dev \
            libssh2-1-dev \
            libssl-dev \
            libtool \
            libtool-bin \
            libudunits2-dev \
            libv8-dev \
            libx11-dev \
            libxml2-dev \
            libz-dev \
            lsb-release \
            nano \
            pandoc \
            pandoc-citeproc \
            parallel \
            pkg-config \
            python3 \
            python3-pip \
            python3-venv \
            software-properties-common \
            sudo \
            systemd \
            texlive \
            tree \
            tzdata \
            unattended-upgrades \
            vim \
            wget \
            xorg
! _koopa_is_docker && sudo DEBIAN_FRONTEND=noninteractive \
    apt-get \
        --fix-missing \
        --no-install-recommends \
        --yes \
        install \
            firefox \
            fish \
            htop \
            perl \
            sqlite3 \
            texlive \
            tmux \
            zsh

_koopa_h2 "Installing recommended dependencies via 'apt-get build-dep'."
# Including 'bash' here will remove 'r-base'.
sudo DEBIAN_FRONTEND=noninteractive \
    apt-get --no-install-recommends --yes build-dep \
        coreutils \
        git \
        htop \
        perl \
        tmux \
        vim \
        zsh
! _koopa_is_docker && sudo DEBIAN_FRONTEND=noninteractive \
    apt-get --no-install-recommends --yes build-dep \
        emacs-defaults \
        fish \
        neovim

_koopa_h2 "Removing unused packages via 'apt-get autoremove'."
sudo apt-get -y autoremove

sudo rm -fr /var/lib/apt/lists/*
