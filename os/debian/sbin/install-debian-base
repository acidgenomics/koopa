#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

# """
# Check package source repo:
# https://packages.ubuntu.com/
#
#
# How to replicate installed packages across machines:
# https://serverfault.com/questions/56848
#
# To backup:
# > sudo dpkg --get-selections > /tmp/dpkglist.txt
#
# To Restore:
# > sudo dpkg --set-selections < /tmp/dpkglist.txt
# > sudo apt-get -y update
# > sudo apt-get dselect-upgrade
#
#
# libcurl4-dev madness:
# Package libcurl-dev is a virtual package provided by:
#   libcurl4-openssl-dev 7.58.0-2ubuntu3.8
#   libcurl4-nss-dev 7.58.0-2ubuntu3.8
#   libcurl4-gnutls-dev 7.58.0-2ubuntu3.8
# You should explicitly select one to install.
# """

_koopa_assert_has_no_args "$@"

dev=1
extra=1
upgrade=1

_koopa_is_docker && extra=0

name_fancy="Debian base system"

_koopa_install_start "$name_fancy"

_koopa_assert_is_installed sed sudo

export DEBIAN_FRONTEND="noninteractive"

# Nuke caches before installing packages.
sudo rm -fr \
    /var/cache/apt/* \
    /var/lib/dpkg/available
sudo dpkg --clear-avail

# Debian symlinks '/usr/local/man' to '/usr/local/share/man' by default, which
# is non-standard and can cause cellar link script to break.
[[ -L /usr/local/man ]] && sudo rm -v /usr/local/man

# Requiring universe repo to be enabled on Ubuntu.
enabled_repos="$(_koopa_apt_enabled_repos)"
if _koopa_is_ubuntu && \
    ! _koopa_is_matching_fixed "$enabled_repos" "universe"
then
    _koopa_stop "The Ubuntu 'universe' repo is disabled. \
Check '/etc/apt/sources.list'."
fi

# Upgrade  {{{1
# ==============================================================================

if [[ "$upgrade" -eq 1 ]]
then
    _koopa_h2 "Upgrading install via 'apt-get dist-upgrade'."
    sudo apt-get update
    sudo DEBIAN_FRONTEND=noninteractive \
        apt-get \
            --fix-missing \
            --no-install-recommends \
            --quiet \
            --yes \
            dist-upgrade
fi

# Default  {{{1
# ==============================================================================

_koopa_h2 "Installing default packages."

# Clean up previous installs first, if applicable.
apt_installed="$(sudo apt list --installed 2> /dev/null)"
legacy_pkgs=(
    cargo               # use 'install-rust'
    containerd          # docker-legacy
    docker              # docker-legacy
    docker-engine       # docker-legacy
    docker.io           # docker-legacy
    fish                # use 'install-fish'
    libgdal-dev         # use 'install-gdal'
    libgeos-dev         # use 'install-geos'
    libgsl-dev          # use 'install-gsl'
    libhdf5-dev         # use 'install-hdf5'
    runc                # docker-legacy
)
for pkg in "${legacy_pkgs[@]}"
do
    echo "$apt_installed" | grep -Eq "^${pkg}/" || continue
    sudo apt-get --yes remove "${pkg[@]}"
done

pkgs=(
    apt-listchanges
    apt-transport-https
    apt-utils
    autoconf
    automake
    bc
    build-essential
    byacc
    bzip2
    ca-certificates
    cmake
    coreutils
    curl
    dirmngr
    findutils
    fortran77-compiler
    g++
    gcc
    gdb
    gdebi-core
    gettext
    gfortran
    git
    gnupg
    gpg-agent
    htop
    less
    libtool
    libtool-bin
    lsb-release
    make
    man-db
    nano
    parallel
    pkg-config
    software-properties-common
    sudo
    tmux
    tree
    tzdata
    unzip
    vim
    wget
    xz-utils
)

# Developer  {{{1
# ==============================================================================

if [[ "$dev" -eq 1 ]]
then
    _koopa_h2 "Installing developer packages."
    pkgs+=(
        # libgdal-dev
        # libgeos-dev
        # libgsl-dev
        # libgslcblas0
        # libhdf5-dev
        # libhdf5-serial-dev
        # libmariadb-dev-compat
        # libnetcdf-dev
        libacl1-dev
        libapparmor-dev
        libbz2-dev
        libc-dev
        libcairo2-dev
        libcurl4-gnutls-dev
        libevent-dev
        libffi-dev
        libfftw3-dev
        libfreetype6-dev
        libgif-dev
        libgl1-mesa-dev
        libglu1-mesa-dev
        libgmp3-dev
        libgnutls28-dev
        libgtk-3-0
        libgtk-3-dev
        libgtk2.0-0
        libgtk2.0-dev
        libgtkmm-2.4-dev
        libharfbuzz-dev
        liblapack-dev
        liblzma-dev
        libmagick++-dev
        libmariadb-dev
        libmodule-build-perl
        libmpfr-dev
        libncurses-dev  # libncurses5-dev
        libopenbabel-dev
        libopenblas-base
        libopenblas-dev
        libopenmpi-dev
        libperl-dev
        libpng-dev
        libpoppler-cpp-dev
        libpq-dev
        libprotobuf-dev
        libprotoc-dev
        librdf0-dev
        libreadline-dev
        libsasl2-dev
        libssh2-1-dev
        libssl-dev
        libtiff5-dev
        libudunits2-dev
        libv8-dev
        libx11-dev
        libxml2-dev
        libxpm-dev
        libxt-dev
        libz-dev  # zlib1g-dev
        tcl-dev
        tk-dev
    )
fi

# Extra  {{{1
# ==============================================================================

if [[ "$extra" -eq 1 ]]
then
    _koopa_h2 "Installing extra recommended packages."
    pkgs+=(
        # default-jdk
        # emacs
        # perl
        # sqlite
        # zsh
        alien
        biber
        ggobi
        gnutls-bin
        graphviz
        gtk-doc-tools
        imagemagick
        jags
        keyboard-configuration
        mpi-default-bin
        openmpi-bin
        openmpi-common
        openmpi-doc
        pandoc
        pandoc-citeproc
        pass
        protobuf-compiler
        systemd
        tabix
        texlive
        unattended-upgrades
        xfonts-100dpi
        xfonts-75dpi
        xorg
    )

    if _koopa_is_ubuntu
    then
        _koopa_info "Installing Ubuntu-specific packages."
        pkgs+=(
            firefox
        )
    fi
fi

sudo apt-get update
sudo DEBIAN_FRONTEND=noninteractive \
    apt-get \
        --fix-broken \
        --fix-missing \
        --no-install-recommends \
        --quiet \
        --yes \
        install "${pkgs[@]}"

_koopa_apt_configure_sources
_koopa_apt_import_keys

# Clean up  {{{1
# ==============================================================================

_koopa_h2 "Removing unused packages."
sudo apt-get --yes clean
sudo apt-get --yes autoremove

_koopa_install_success "$name_fancy"
