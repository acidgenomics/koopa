#!/usr/bin/env bash

koopa_git_checkout_recursive() {
    # """
    # Checkout to a different branch on multiple git repos.
    # @note Updated 2021-11-23.
    # """
    local app dict dirs pos
    declare -A app=(
        ['git']="$(koopa_locate_git --allow-system)"
    )
    [[ -x "${app['git']}" ]] || return 1
    declare -A dict=(
        ['branch']=''
        ['origin']=''
    )
    pos=()
    while (("$#"))
    do
        case "$1" in
            # Key-value pairs --------------------------------------------------
            '--branch='*)
                dict['branch']="${1#*=}"
                shift 1
                ;;
            '--branch')
                dict['branch']="${2:?}"
                shift 2
                ;;
            '--origin='*)
                dict['origin']="${1#*=}"
                shift 1
                ;;
            '--origin')
                dict['origin']="${2:?}"
                shift 2
                ;;
            # Other ------------------------------------------------------------
            '-'*)
                koopa_invalid_arg "$1"
                ;;
            *)
                pos+=("$1")
                shift 1
                ;;
        esac
    done
    [[ "${#pos[@]}" -gt 0 ]] && set -- "${pos[@]}"
    dirs=("$@")
    koopa_is_array_empty "${dirs[@]}" && dirs[0]="${PWD:?}"
    koopa_assert_is_dir "${dirs[@]}"
    # Using a single subshell here to avoid performance hit during looping.
    # This single subshell is necessary so we don't change working directory.
    (
        local dir
        for dir in "${dirs[@]}"
        do
            local repo repos
            dir="$(koopa_realpath "$dir")"
            readarray -t repos <<< "$( \
                koopa_find \
                    --max-depth=3 \
                    --min-depth=2 \
                    --pattern='.git' \
                    --prefix="$dir" \
                    --sort \
            )"
            if koopa_is_array_empty "${repos[@]:-}"
            then
                koopa_stop "Failed to detect any repos in '${dir}'."
            fi
            koopa_h1 "Checking out ${#repos[@]} repos in '${dir}'."
            for repo in "${repos[@]}"
            do
                local dict2
                declare -A dict2
                koopa_h2 "$repo"
                koopa_cd "$repo"
                dict2['branch']="${dict['branch']}"
                dict2['default_branch']="$(koopa_git_default_branch)"
                if [[ -z "${dict2['branch']}" ]]
                then
                    dict2['branch']="${dict2['default_branch']}"
                fi
                if [[ -n "${dict['origin']}" ]]
                then
                    "${app['git']}" fetch --all
                    if [[ "${dict2['branch']}" \
                        != "${dict2['default_branch']}" ]]
                    then
                        "${app['git']}" checkout "${dict2['default_branch']}"
                        "${app['git']}" branch -D "${dict2['branch']}" || true
                    fi
                    "${app['git']}" checkout \
                        -B "${dict2['branch']}" \
                        "${dict['origin']}"
                else
                    "${app['git']}" checkout "${dict2['branch']}"
                fi
                "${app['git']}" branch -vv
            done
        done
    )
    return 0
}
