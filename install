#!/usr/bin/env bash
set -Eeuo pipefail

# Install koopa.
# Modified 2019-06-13.

# Set `dev=1` to enable some additional developer configuration tweaks.
# Namely, this currently changes submodule remotes from HTTPS to git.

koopa_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
install_dir="${koopa_dir}/system/install"



# Activate koopa                                                            {{{1
# ==============================================================================

# Ensure koopa is activated, otherwise we'll hit unbound variable errors.

# shellcheck source=/dev/null
. "${koopa_dir}/activate"



# Initialize submodules                                                     {{{1
# ==============================================================================
(
    echo "Initializing submodules."
    # shellcheck source=/dev/null
    cd "$koopa_dir"
    git submodule init
    git submodule update --init --recursive
    git submodule sync --recursive
)

(
    echo "Initializing dotfiles submodules."
    # shellcheck source=/dev/null
    cd "${koopa_dir}/dotfiles"
    git submodule init
    git submodule update --init --recursive
    git submodule sync --recursive
    # Change remote from HTTPS to git for easier commits.
    if [[ -n "${dev:-}" ]]
    then
        git remote set-url origin git@github.com:mjsteinbaugh/dotfiles.git
    fi
)



# Dot file symlinks                                                         {{{1
# ==============================================================================

# Skip this step for root.
if [ "$(id -u)" -ne 0 ]
then
    # shellcheck source=/dev/null
    . "${install_dir}/dotfiles.sh"
fi

