#!/usr/bin/env bash

# Install koopa.
# Updated 2019-07-27.

KOOPA_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"

# shellcheck source=system/include/functions.sh
source "${KOOPA_HOME}/system/include/functions.sh"



# Error on root user.
[[ "$(id -u)" -eq 0 ]] &&
    >&2 printf "Don't run this script as root.\n" &&
    return 1


# Usage                                                                     {{{1
# ==============================================================================

usage() {
    cat << EOF
usage: install [-h]

Install koopa.

This script performs the following steps:

  1. Initialize top-level submodules (e.g. dotfiles).
  2. Recurse into dotfiles repo and initialize additional submodules.
  3. Configure profile for current user (default; e.g. '~/.bashrc'), or shared
     profile (use '--shared' flag) via '/etc/profile.d/'.

optional arguments:
  -h, --help
        Show this help message and exit.
  --devel
        Enable developer mode. This changes the repository URLs from HTTPS
        to SSH, for easier code commits.
  --dotfiles
        Automatically generate dot file symlinks.
  --mike
        Install Mike-specific configuration.
        This flag automatically enables '--devel' and '--dotfiles'.
  --shared
        Configure shared installation using '/etc/profile.d'.
        Automatically enabled when installed in '/usr/local' or '/opt'.
EOF
}



# Parse arguments                                                           {{{1
# ==============================================================================

while (("$#"))
do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        --devel)
            devel=1
            shift 1
            ;;
        --mike)
            mike=1
            shift 1
            ;;
        --dotfiles)
            dotfiles=1
            shift 1
            ;;
        --shared)
            shared=1
            shift 1
            ;;
        --) # End argument parsing.
            shift
            break
            ;;
        --*|-*) # Unsupported flags.
            >&2 printf "Error: Invalid flag %s\n" "$1"
            exit 1
            ;;
    esac
done

if [[ "${mike:-0}" -eq 1 ]]
then
    devel=1
    dotfiles=1
fi



# Remove legacy cruft                                                       {{{1
# ==============================================================================

rm -rf "${KOOPA_HOME}/bin/"{host,os,sudo}
rm -rf "${KOOPA_HOME}/"{config,dotfiles,include}



# Shared user configuration                                                 {{{1
# ==============================================================================

# Checking for '/usr/local' installation automatically.
if echo "$KOOPA_HOME" | grep -qE "^/(opt|usr/local)/"
then
    printf "\nShared installation detected at '%s'.\n" "$KOOPA_HOME"
    shared=1
fi

if [[ "${shared:-0}" -eq 1 ]]
then
    _koopa_update_profile
fi



# Initialize submodules                                                     {{{1
# ==============================================================================

if [[ "${dotfiles:-0}" -eq 1 ]]
then
    (
        printf "\nInitializing submodules.\n"
        cd "$KOOPA_HOME" || exit 1
        git submodule init
        git submodule update --init --recursive
        git submodule sync --recursive
        # Change remote from HTTPS to git for easier commits.
        if [[ -n "${devel:-}" ]]
        then
            git remote set-url origin git@github.com:acidgenomics/koopa.git
        fi
    )

    (
        printf "\nInitializing dotfiles submodules.\n"
        cd "${KOOPA_HOME}/system/config/dotfiles" || exit 1
        git submodule init
        git submodule update --init --recursive
        git submodule sync --recursive
        # Change remote from HTTPS to git for easier commits.
        if [[ -n "${devel:-}" ]]
        then
            git remote set-url origin git@github.com:mjsteinbaugh/dotfiles.git
        fi
    )
fi



# Activate koopa                                                            {{{1
# ==============================================================================

printf "\nActivating koopa.\n"
# shellcheck source=activate
force=1 . "${KOOPA_HOME}/activate"



# Dot files                                                                 {{{1
# ==============================================================================

if [[ "${dotfiles:-0}" -eq 1 ]]
then
    printf "\nConfiguring dotfiles.\n"

    # Always create these dotfiles, even on a shared installation.
    # shellcheck source=system/install/dotfiles-shared.sh
    source "${KOOPA_HOME}/system/install/dotfiles-shared.sh"

    # Create local config files.
    # shellcheck source=system/install/dotfiles-local.sh
    [[ -z "${shared:-}" ]] &&
        source "${KOOPA_HOME}/system/install/dotfiles-local.sh"

    # Configure Mike's dotfiles.
    # shellcheck source=system/install/dotfiles-mike.sh
    [[ "${mike:-}" -eq 1 ]] &&
        source "${KOOPA_HOME}/system/install/dotfiles-mike.sh"

    # Remove legacy dotfile cruft.
    # shellcheck source=system/uninstall/dotfiles-legacy.sh
    source "${KOOPA_HOME}/system/uninstall/dotfiles-legacy.sh"
fi



# Additional scripts                                                        {{{1
# ==============================================================================

# Clone additional Git repos of interest.
if [[ "${mike:-}" -eq 1 ]]
then
    # shellcheck source=system/install/docker-mike.sh
    source "${KOOPA_HOME}/system/install/docker-mike.sh"
    # shellcheck source=system/install/scripts-mike.sh
    source "${KOOPA_HOME}/system/install/scripts-mike.sh"
fi
