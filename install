#!/usr/bin/env bash
set -Eeu -o pipefail

# Install koopa.
# Modified 2019-06-17.

# Set `dev=1` to enable some additional developer configuration tweaks.
# Namely, this currently changes submodule remotes from HTTPS to git.

koopa_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"



# Flags                                                                     {{{1
# ==============================================================================

while (("$#"))
do
    case "$1" in
        -h|--help)
            help=1
            shift 1
            ;;
        --mike)
            mike=1
            shift 1
            ;;
        --no-dotfiles)
            dotfiles=0
            shift 1
            ;;
        --shared)
            shared=1
            shift 1
            ;;
        --) # End argument parsing.
            shift
            break
            ;;
        --*|-*) # Unsupported flags.
            >&2 printf "Error: Invalid flag %s\n" "$1"
            exit 1
            ;;
    esac
done



# Help mode                                                                 {{{1
# ==============================================================================

if [[ -n "${help:-}" ]]
then
    cat << EOF
Install koopa.

This script performs the following steps:

    1. Initialize top-level submodules (e.g. dotfiles).
    2. Recurse into dotfiles repo and initialize additional submodules.
    3. Configure profile for current user (default; e.g. '~/.bashrc'), or
       shared profile (use '--shared' flag) via '/etc/profile.d/'.

Flags:

    -h, --help
        Help mode.
        
    --mike
        Install Mike-specific dotfiles (e.g. gitconfig).

    Linux only:
    
    --no-dotfiles
        Skip automatic generation of dotfile symlinks.
    --shared
        Configure shared installation using '/etc/profile.d'.
EOF
    exit
fi



# Activate koopa                                                            {{{1
# ==============================================================================

# Ensure koopa is activated, otherwise we'll hit unbound variable errors.

# shellcheck source=/dev/null
. "${koopa_dir}/activate"



# Initialize submodules                                                     {{{1
# ==============================================================================
(
    printf "\nInitializing submodules.\n"
    # shellcheck source=/dev/null
    cd "$koopa_dir"
    git submodule init
    git submodule update --init --recursive
    git submodule sync --recursive
)

(
    printf "\nInitializing dotfiles submodules.\n"
    # shellcheck source=/dev/null
    cd "${koopa_dir}/config/dotfiles"
    git submodule init
    git submodule update --init --recursive
    git submodule sync --recursive
    # Change remote from HTTPS to git for easier commits.
    if [[ -n "${dev:-}" ]]
    then
        git remote set-url origin git@github.com:mjsteinbaugh/dotfiles.git
    fi
)



# Shared user configuration                                                 {{{1
# ==============================================================================

# Check for '/usr/local' and enable shared mode automatically.

if [[ -n "${shared:-}" ]]
then
    if [[ -z "$LINUX" ]]
    then
        >&2 echo "Error: Shared configuration is only supported on Linux."
        exit 1
    fi
    echo "Adding 'koopa.sh' to '/etc/profile.d/'."
    sudo mkdir -p /etc/profile.d
    sudo ln -fs \
        "${koopa_dir}/config/etc/profile.d/koopa.sh" \
       /etc/profile.d/koopa.sh
fi



# Current user dot files                                                    {{{1
# ==============================================================================

# Never attempt to configure dotfiles for root.
[[ "$(id -u)" -eq 0 ]] && dotfiles=0

if [[ -z "${shared:-}" ]] && [[ "${dotfiles:-1}" -eq 1 ]]
then
    . "${KOOPA_DIR}/system/install/dotfiles.sh"
    . "${KOOPA_DIR}/system/uninstall/dotfiles-legacy.sh"
fi
