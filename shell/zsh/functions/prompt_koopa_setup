#!/usr/bin/env zsh

# Koopa ZSH prompt
# Updated 2019-09-17.

# Modified, lighter version of Pure, by Sindre Sorhus.
# https://github.com/sindresorhus/pure



# Debugging:
# > typeset _koopa_prompt_state

# Prompt:
# - %F     => color dict
# - %f     => reset color
# - %~     => current path
# - %*     => time
# - %n     => username
# - %m     => shortname host
# - %(?..) => prompt conditional - %(condition.true.false)

# Terminal codes:
# - \e7   => save cursor position
# - \e[2A => move cursor 2 lines up
# - \e[1G => go to position 1 in terminal
# - \e8   => restore cursor position
# - \e[K  => clears everything after the cursor on the current line
# - \e[2K => clear everything on the current line



_koopa_prompt_precmd() {
    # Always include an initial line break.
    print
    # Warn the user about potential theme conflict.
    if [[ -n "${ZSH_THEME:-}" ]]
    then
        >&2 print "WARNING: Oh My Zsh theme is enabled."
        unset ZSH_THEME
    fi
}



# Set the user string and color based on local or SSH connection.
_koopa_prompt_state_setup() {
    local user wd
    if [[ -n "${SSH_CONNECTION:-}" ]] 
    then
        user='%F{$_koopa_prompt_colors[user:ssh]}%n@%m%f'
    else
        user='%F{$_koopa_prompt_colors[user]}%n@%m%f'
    fi
    wd='%F{${_koopa_prompt_colors[path]}}%~%f'
    typeset -gA _koopa_prompt_state
    # Note that Unicode doesn't work well with some fonts on Windows.
    _koopa_prompt_state+=(
        prompt  "$"
        user    "$user"
        wd      "$wd"
    )
}



_koopa_prompt_setup() {
    setopt localoptions noshwordsplit
    prompt_opts=(subst percent)

    # This variable needs to be set, usually set by promptinit.
    if [[ -z "${prompt_newline:-}" ]]
    then
        typeset -g prompt_newline=$'\n%{\r%}'
    fi

    # > zmodload zsh/datetime
    # > zmodload zsh/zle
    # > zmodload zsh/parameter
    # > zmodload zsh/zutil
    
    # Set the colors.
    typeset -gA _koopa_prompt_colors_default _koopa_prompt_colors
    _koopa_prompt_colors_default=(
        path                 blue
        prompt:error         red
        prompt:success       magenta
        user                 cyan
        user:ssh             yellow
        virtualenv           default
    )
    _koopa_prompt_colors=("${(@kv)_koopa_prompt_colors_default}")

    # Run pre commeands.
    add-zsh-hook precmd _koopa_prompt_precmd
    
    # Set up the prompt variables.
    _koopa_prompt_state_setup

    # Construct the new prompt with a clean preprompt.
    # Join parts, space separated.
    local -ah header ps1
    
    header=(
        "${_koopa_prompt_state[user]}"
        "\$(koopa prompt-conda-env)"
        "\$(koopa prompt-python-env)"
    )
    header="${(j..)header}"
    
    ps1=(
        "$header"
        "$prompt_newline"
        "${_koopa_prompt_state[wd]}"
        "$prompt_newline"
    )
    
    # Coerce array to string.
    PROMPT="${(j..)ps1}"
    
    # Prompt turns red if the previous command didn't exit with 0.
    PROMPT+='%(?.%F{$_koopa_prompt_colors[prompt:success]}.%F{$_koopa_prompt_colors[prompt:error]})${_koopa_prompt_state[prompt]}%f '

    # Guard against Oh My Zsh themes overriding the prompt.
    unset -v ZSH_THEME
}



_koopa_prompt_setup "$@"
