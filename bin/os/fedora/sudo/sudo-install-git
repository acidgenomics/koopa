#!/usr/bin/env bash
set -Eeuo pipefail

# Git SCM
# https://git-scm.com/
#
# See also:
# - https://github.com/git/git
# - https://git-scm.com/book/en/v2/Getting-Started-Installing-Git
# - https://github.com/git/git/blob/master/INSTALL
# - https://github.com/progit/progit2/blob/master/book/01-introduction/sections/installing.asc

prefix="/usr/local"
build_name="$KOOPA_OS_BUILD_STRING"
build_dir="${KOOPA_TMP}/build/git"

version="2.21.0"

echo "Installing git ${version}."



# OpenSSL note
#
# This currently fails if OpenSSL v1.1.1+ is installed to `/usr/local`.
# Instead, compile Git to use the system OpenSSL in `/bin/`.
#
# You'll see this error message otherwise:
#
#     CC imap-send.o
#     LINK git-imap-send
# imap-send.o: In function `sk_GENERAL_NAME_num':
# /usr/local/include/openssl/x509v3.h:166: undefined reference to `OPENSSL_sk_num'
# imap-send.o: In function `sk_GENERAL_NAME_value':
# /usr/local/include/openssl/x509v3.h:166: undefined reference to `OPENSSL_sk_value'
# imap-send.o: In function `sk_GENERAL_NAME_pop_free':
# /usr/local/include/openssl/x509v3.h:166: undefined reference to `OPENSSL_sk_pop_free'
# /usr/local/include/openssl/x509v3.h:166: undefined reference to `OPENSSL_sk_pop_free'
# imap-send.o: In function `ssl_socket_connect':
# /tmp/build/git/git-2.21.0/imap-send.c:287: undefined reference to `OPENSSL_init_ssl'
# /tmp/build/git/git-2.21.0/imap-send.c:288: undefined reference to `OPENSSL_init_ssl'
# /tmp/build/git/git-2.21.0/imap-send.c:290: undefined reference to `TLS_method'
# /tmp/build/git/git-2.21.0/imap-send.c:303: undefined reference to `SSL_CTX_set_options'
# collect2: error: ld returned 1 exit status
# make: *** [git-imap-send] Error 1



# Run preflight initialization checks.
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
# shellcheck source=/dev/null
. "${script_dir}/__init__.sh"

# Install build dependencies.
sudo yum-builddep -y git

# This is required for git to make doc cleanly.
#
# Otherwise, you'll see this error:
# /bin/sh: line 1: docbook2x-texi: command not found
#
# This issue is reference here:
# https://github.com/progit/progit2/issues/425
#
# Note the capital "X" here. This differs depending on the Linux distro.
# We're assuming Red Hat here.
#
# EPEL7 must be enabled for this to install (e.g. on Amazon Linux 2).
sudo yum install -y docbook2X

# This step is required to fix a binary name difference.
if [[ ! -f /usr/bin/docbook2x-texi ]]
then
    sudo ln -s /usr/bin/db2x_docbook2texi /usr/bin/docbook2x-texi
fi

# SC2103: Use a ( subshell ) to avoid having to cd back.
(
    rm -rf "$build_dir"
    mkdir -p "$build_dir"
    cd "$build_dir" || return 1
    wget "https://github.com/git/git/archive/v${version}.tar.gz"
    tar -zxf "v${version}.tar.gz"
    cd "git-${version}" || return 1
    # The compilation settings here are from the Git SCM book website.
    # Refer also to INSTALL file for details.
    make configure
    ./configure \
        --build="$build_name" \
        --prefix="$prefix" \
        --with-openssl="/bin/openssl"
    make all doc info
    sudo make install install-doc install-html install-info
    rm -rf "$build_dir"
)

# Ensure ldconfig is current.
sudo ldconfig

echo "git installed successfully."
command -v git
git --version
