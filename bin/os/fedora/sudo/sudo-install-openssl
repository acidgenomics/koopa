#!/usr/bin/env bash
set -Eeu -o pipefail

# Install OpenSSL.

# See also:
# - https://www.openssl.org/source/
# - https://wiki.openssl.org/index.php/Compilation_and_Installation
# - https://wiki.openssl.org/index.php/Binary_Compatibility

# shellcheck source=/dev/null
source "${KOOPA_DIR}/include/os/fedora/sudo.sh"

prefix="$KOOPA_PREFIX"
openssldir="$prefix"
tmp_dir="${KOOPA_TMP_DIR}/openssl"
version="$(koopa variable openssl)"

printf "Installing openssl %s.\n" "$version"

# Install build dependencies.
sudo yum-builddep -y openssl

(
    rm -rf "$tmp_dir"
    mkdir -p "$tmp_dir"
    cd "$tmp_dir" || exit 1
    curl -O "https://www.openssl.org/source/openssl-${version}.tar.gz"
    tar -xvzf "openssl-${version}.tar.gz"
    cd "openssl-${version}" || exit 1
    ./config \
        --prefix="$prefix" \
        --openssldir="$openssldir" \
        shared
    make
    make test
    sudo make install
    rm -rf "$tmp_dir"
)

sudo ldconfig

cat << EOF
Reload the current shell.

> command -v openssl
> openssl version
> openssl ciphers -v
EOF
