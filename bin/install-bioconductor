#!/usr/bin/env Rscript

## Intentionally not including koopa R header here, so we can install
## Bioconductor clean before installing any additional koopa dependencies.

local({
    ## Treat all warnings as errors.
    warn <- getOption("warn")
    options("warn" = 2L)
    posArgs <- commandArgs(trailingOnly = TRUE)
    if (!requireNamespace("BiocManager", quietly = TRUE)) {
        install.packages("BiocManager")
    }
    if (isTRUE(grepl(pattern = "^--version=", x = posArgs))) {
        x <- grep(
            pattern = "^--version=(.+)$",
            x = posArgs,
            value = TRUE
        )
        version <- strsplit(x = x, split = "=", fixed = TRUE)[[1L]][[2L]]
    } else if (isTRUE(nzchar(Sys.getenv("BIOC_VERSION")))) {
        version <- Sys.getenv("BIOC_VERSION")
    } else {
        version <- BiocManager::version()
    }
    message(sprintf("Installing Bioconductor %s.", version))
    BiocManager::install(
        update = FALSE,
        ask = FALSE,
        version = version
    )
    BiocManager::install(
        pkgs = "BiocCheck",
        update = FALSE,
        ask = FALSE
    )
    options("warn" = warn)
    invisible(TRUE)
})
