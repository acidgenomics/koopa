#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../shell/bash/include/header.sh"

koopa::rsync_ignore() {
    # """
    # Run rsync with automatic ignore.
    # @note Updated 2020-07-10.
    # @seealso
    # https://stackoverflow.com/questions/13713101/
    # """
    local global ignore_global pos rsync_flags
    koopa::assert_has_args "$#"
    koopa::assert_is_installed rsync
    global=0
    pos=()
    while (("$#"))
    do
        case "$1" in
            --global)
                global=1
                shift 1
                ;;
            --)
                shift 1
                break
                ;;
            --*|-*)
                koopa::invalid_arg "$1"
                ;;
            *)
                pos+=("$1")
                shift 1
                ;;
        esac
    done
    [[ "${#pos[@]}" -gt 0 ]] && set -- "${pos[@]}"
    rsync_flags=(
        # '--exclude=.*/'
        # '--exclude=/.git'
        # '--filter=:- .gitignore'
        '--archive'
        '--exclude=.*'
        '--filter=dir-merge,- .gitignore'
        '--human-readable'
        '--progress'
    )
    if [[ "$global" -eq 1 ]]
    then
        ignore_global="${HOME}/.gitignore"
        koopa::assert_is_file "$ignore_global"
        rsync_flags+=("--filter=dir-merge,- ${ignore_global}")
    fi
    rsync "${rsync_flags[@]}" "$@"
    return 0
}

koopa::rsync_ignore "$@"
