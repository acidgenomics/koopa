#!/usr/bin/env bash

KOOPA_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_HOME}/shell/bash/include/header.sh"



# Usage                                                                     {{{1
# ==============================================================================

usage() {
cat << EOF
$(_koopa_help_header)
    [--config] [--force] [--private] [--quiet]
    relative_path [symlink_name]

Symlink a dot file.

required positional arguments:
    1.  relative_path
        Relative file path in dotfiles repo.

optional positional arguments:
    2.  symlink_name
        Name of target symlink (without '.' prefix).
        If unset, uses basename from relative_path argument.

optional arguments:
    --config
        Symlink into XDG config directory instead of user home.
        This path is defined by 'XDG_CONFIG_HOME' and defaults to '~/.config/'.
    --force
        Force overwrite.
        Applies to symlinks only.
    --private
        Link a private dot file.
        Checks in 'scripts-private/' directory in koopa config.
        Defaults to '~/.config/koopa/scripts-private/'.

$(_koopa_help_args)

details:
    The relative file path in dotfiles repo can be used as input. The target
    file should be specified without a leading period.

    By default, this script is designed to work with the 'mjsteinbaugh/dotfiles'
    repository available on GitHub.

examples:
    dotfile zshrc
    dotfile --config doom

note:
    Bash script.
    Updated 2019-09-27.
EOF
}

[[ -z "$*" ]] && usage && exit 0
_koopa_help "$@"



# Parse arguments                                                           {{{1
# ==============================================================================

config=0
force=0
private=0

POSITIONAL=()
while (("$#"))
do
    case "$1" in
        --config)
            config=1
            shift 1
            ;;
        --force)
            force=1
            shift 1
            ;;
        --private)
            private=1
            shift 1
            ;;
        --)
            shift 1
            break
            ;;
        --*|-*)
            >&2 printf "Error: Invalid argument: '%s'\n" "$1"
            exit 1
            ;;
        *)
            POSITIONAL+=("$1")
            shift 1
            ;;
    esac
done
set -- "${POSITIONAL[@]}"

source_name="$1"
symlink_name="${2:-}"



# Script                                                                    {{{1
# ==============================================================================

# Note that we're creating a symlink in local user config.
dot_dir="$(_koopa_config_dir)/dotfiles"

# Create a dotfile symlink in config dir, if necessary.
dot_repo="$(_koopa_home)/dotfiles"
if [[ -d "$dot_repo"  ]] && [[ ! -d "$dot_dir" ]]
then
    rm -frv "$dot_dir"
    ln -fnsv "$dot_repo" "$dot_dir"
fi

# Private file.
if [[ "$private" -eq 1 ]]
then
    dot_dir="${dot_dir}-private"
fi
_koopa_assert_is_dir "$dot_dir"

if [[ "$config" -eq 1 ]]
then
    source_path="${dot_dir}/config/${source_name}"
else
    source_path="${dot_dir}/${source_name}"
fi
_koopa_assert_is_existing "$source_path"

# Define optional target symlink name.
if [[ -z "$symlink_name" ]]
then
    symlink_name="$(basename "$source_path")"
fi

# Add link either in HOME (default) or XDG_CONFIG_HOME.
if [[ "$config" -eq 1 ]]
then
    if [[ -z "${XDG_CONFIG_HOME:-}" ]]
    then
        >&2 printf "Warning: 'XDG_CONFIG_HOME' is unset.\n"
        XDG_CONFIG_HOME="${HOME}/.config"
    fi
    symlink_path="${XDG_CONFIG_HOME}/${symlink_name}"
else
    symlink_path="${HOME}/.${symlink_name}"
fi

# Inform the user when nuking a broken symlink.
if [[ -L "$symlink_path" ]] && [[ ! -e "$symlink_path" ]]
then
    printf "Overwriting broken link: '%s'.\n" "$symlink_path"
    rm -fv "$symlink_path"
fi

# We're allowing force overwrite of existing symlinks only.
if [[ -L "$symlink_path" ]] &&
    [[ -f "$symlink_path" || -d "$symlink_path" ]] &&
    [[ "$force" -eq 0 ]]
then
    >&2 printf "Error: Existing symlink: '%s'.\n" "$symlink_path"
    exit 1
elif [[ ! -L "$symlink_path" ]] && [[ -e "$symlink_path" ]]
then
    >&2 printf "Error: Existing file: '%s'.\n" "$symlink_path"
    exit 1
fi

printf "Symlinking '%s'.\n" "$(basename "$symlink_path")"
rm -fv "$symlink_path"
ln -fnsv "$source_path" "$symlink_path"
