#!/usr/bin/env bash

KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"

_koopa_assert_has_args "$@"
_koopa_assert_is_installed "docker"

bash=0
workdir="/mnt/work"

pos=()
while (("$#"))
do
    case "$1" in
        --bash)
            bash=1
            shift 1
            ;;
        --workdir=*)
            workdir="${1#*=}"
            shift 1
            ;;
        --workdir)
            workdir="$2"
            shift 2
            ;;
        --)
            shift 1
            break
            ;;
        --*|-*)
            _koopa_invalid_arg "$1"
            ;;
        *)
            pos+=("$1")
            shift 1
            ;;
    esac
done
if [[ "${#pos[@]}" -gt 0 ]]
then
    set -- "${pos[@]}"
fi

image="$1"
workdir="$(_koopa_strip_trailing_slash "$workdir")"

docker pull "$image"

flags=(
    "--interactive"
    "--tty"
    "--volume=${PWD}:${workdir}"
    "--workdir=${workdir}"
    "$image"
)

if [[ "$bash" -eq 1 ]]
then
    flags+=("bash" "-il")
fi

docker run "${flags[@]}"
