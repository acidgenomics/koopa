#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../shell/bash/include/header.sh"

# """
# Update all pip packages.
#
# See also:
# - https://github.com/pypa/pip/issues/59
# - https://stackoverflow.com/questions/2720014
# """

koopa::exit_if_not_installed pip3 python3
koopa::assert_has_no_args "$#"
koopa::assert_has_no_envs

name_fancy="Python packages"

koopa::install_start "$name_fancy"

x="$(python3 -m pip list --outdated --format=freeze)"
x="$(koopa::print "$x" | grep -v '^\-e')"

if [[ -z "$x" ]]
then
    koopa::success "All Python packages are current."
    exit 0
fi

prefix="$(koopa::python_site_packages_prefix)"

readarray -t pkgs <<< "$(koopa::print "$x" | cut -d '=' -f 1)"
koopa::dl "Packages" "$(koopa::to_string "${pkgs[@]}")"
koopa::dl "Prefix" "$prefix"

python3 -m pip install \
    --no-warn-script-location \
    --upgrade \
    "${pkgs[@]}"

koopa::is_cellar python3 && koopa::link_cellar python

koopa::install_success "$name_fancy"
