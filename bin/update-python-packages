#!/usr/bin/env bash

KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"

# """
# Update all pip packages.
#
# See also:
# - https://github.com/pypa/pip/issues/59
# - https://stackoverflow.com/questions/2720014
# """

_koopa_exit_if_not_installed pip3 python3
_koopa_assert_has_no_args "$@"
_koopa_assert_has_no_envs

name_fancy="Python packages"

_koopa_install_start "$name_fancy"

x="$(python3 -m pip list --outdated --format=freeze)"
x="$(_koopa_print "$x" | grep -v '^\-e')"

if [[ -z "$x" ]]
then
    _koopa_success "All Python packages are current."
    exit 0
fi

prefix="$(_koopa_python_site_packages_prefix)"

mapfile -t pkgs < <(_koopa_print "$x" | cut -d '=' -f 1)
_koopa_dl "Packages" "$(_koopa_to_string "${pkgs[@]}")"
_koopa_dl "Prefix" "$prefix"

python3 -m pip install \
    --no-warn-script-location \
    --upgrade \
    "${pkgs[@]}"

_koopa_is_cellar python3 && _koopa_link_cellar python

_koopa_install_success "$name_fancy"
