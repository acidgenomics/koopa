#!/usr/bin/env bash

KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." &>/dev/null && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"

dir="${1:-"."}"
dir="$(realpath "$dir")"

# Using '-L' flag here in case git dir is a symlink.
readarray -t repos <<< "$( \
    find -L "$dir" \
        -mindepth 1 \
        -maxdepth 2 \
        -name ".git" \
        -print \
)"

if ! _koopa_is_array_non_empty "${repos[@]}"
then
    _koopa_stop "Failed to detect any git repos."
fi

_koopa_h1 "Pushing ${#repos[@]} git repos recursively at '${dir}'."

for repo in "${repos[@]}"
do
    repo="$(dirname "$repo")"
    _koopa_h2 "$(basename "$repo")"
    (
        cd "$repo" || exit 1
        pwd
        git push
    )
done
