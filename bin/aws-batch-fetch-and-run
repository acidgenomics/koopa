#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../shell/bash/include/header.sh"

# """
# Fetch and run a script.
#
# S3 bucket paths and remote URLs are supported.
#
# See also:
# - https://github.com/FredHutch/url-fetch-and-run
# - https://github.com/awslabs/aws-batch-helpers
# """

_koopa_assert_is_installed aws curl unzip
_koopa_assert_is_set BATCH_FILE_URL

url="$BATCH_FILE_URL"
file="$(_koopa_tmp_file)"

case "$url" in
    ftp|http*)
        _koopa_download "$url" "$file"
        ;;
    s3*)
        aws s3 cp "$url" "$file"
        ;;
    *)
        _koopa_stop "Unsupported URL: '${url}'."
        ;;
esac

chmod u+x "$file"
exec "$file" "${@}"
