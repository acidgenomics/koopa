#!/usr/bin/env bash
set -Eeu -o pipefail

KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"
_koopa_assert_has_args "$@"

grep_array=(
    '^([0-9]{4})'
    '([-_])?'
    '([0-9]{2})'
    '([-_])?'
    '([0-9]{2})'
    '([-_])?'
    '([0-9]{2})'
    '([-_])?'
    '([0-9]{2})'
    '([-_])?'
    '([0-9]{2})'
    '(.+)$'
)
grep_string="$(printf %s "${grep_array[@]}" $'\n')"

for file in "$@"
do
    # Using Bash built-in regular expressions here.
    if [[ "$file" =~ $grep_string ]]
    then
        year="${BASH_REMATCH[1]}"
        month="${BASH_REMATCH[3]}"
        day="${BASH_REMATCH[5]}"
        subdir="${year}/${month}/${day}"
        mkdir --parents --verbose "$subdir"
        mv --no-clobber --verbose "$file" "$subdir"
    else
        _koopa_stop "'${file}' does not contain date."
    fi
done
