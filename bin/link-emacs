#!/usr/bin/env bash

KOOPA_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_HOME}/shell/bash/include/header.sh"
_acid_assert_has_args "$@"

name="$1"

default_home=".emacs.d"
default_dir="${HOME}/${default_home}"
default_dir="${2:-$default_dir}"

custom_home="${default_home}-${name}"
custom_dir="${HOME}/${custom_home}"
_acid_assert_is_dir "$custom_dir"

if [ -d "$default_dir" ] && [ ! -L "$default_dir" ]
then
    _acid_stop "Emacs directory detected at '${default_dir}'."
fi

(
    cd "$HOME" || exit 1
    if [[ "$name" != "minimal" ]]
    then
        rm -fv ".emacs"
    elif [[ "$name" != "spacemacs" ]]
    then
        rm -fv ".spacemacs"
    fi
    case "$name" in
        doom)
            link-dotfile --force --config "app/emacs/doom/config.d" "doom"
            ;;
        minimal)
            link-dotfile --force "app/emacs/minimal/emacs.el"
            ;;
        spacemacs)
            link-dotfile --force "app/emacs/spacemacs/spacemacs.el" "spacemacs"
            ;;
        *)
            _acid_stop "Invalid Emacs config name."
            ;;
    esac
    ln -fnsv "$custom_home" "$default_home"
)
