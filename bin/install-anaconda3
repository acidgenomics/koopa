#!/usr/bin/env bash
set -Eeu -o pipefail

# Install Anaconda.
# Modified 2019-06-18.

# See also:
# - https://www.anaconda.com/download
# - https://docs.anaconda.com/anaconda/install/

# shellcheck source=/dev/null
source "${KOOPA_DIR}/include/shell/bash/functions.sh"

assert_has_no_environments

prefix="${KOOPA_PREFIX}/anaconda3"
tmp_dir="${KOOPA_TMP_DIR}/anaconda3"
version="$(koopa variable anaconda3)"

case "$OSTYPE" in
    linux-gnu)
        script="Anaconda3-${version}-Linux-x86_64.sh"
        ;;
    darwin*)
        script="Anaconda3-${version}-MacOSX-x86_64.sh"
        ;;
    *)
        >&2 printf "Error: %s is not supported." "$OSTYPE"
        exit 1
        ;;
esac

prefix_mkdir "$prefix"

(
    rm -rf "$tmp_dir"
    mkdir -p "$tmp_dir"
    cd "$tmp_dir"
    curl -O "https://repo.anaconda.com/archive/${script}"
    bash "$script" -bf -p "$prefix"
    rm -rf "$tmp_dir"
)

prefix_chgrp "$prefix"

conda_exe="${prefix}/bin/conda"
command -v "$conda_exe"
"$conda_exe --version"
