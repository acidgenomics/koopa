#!/usr/bin/env bash

# koopa shell bootloader
# (c) 2018 Michael Steinbaugh
# This software is provided under an MIT License.

if [[ -z $BASH_VERSION ]]
then
    echo "koopa is only compatible with bash."
    echo 'Failed to detect bash version ($BASH_VERSION).'
    echo "Check your configuration."
    return 1
elif [[ $BASH_VERSION < 4 ]]
then
    echo "bash version: $BASH_VERSION"
    echo ""
    echo "koopa requires bash >= v4 to be installed."
    echo ""
    echo "Running macOS?"
    echo "Apple refuses to include a modern version due to the license."
    echo ""
    echo "Here's how to upgrade it using Homebrew:"
    echo "1. Install Homebrew."
    echo "   https://brew.sh/"
    echo "2. Install bash."
    echo "   brew install bash"
    echo "3. Update list of acceptable shells."
    echo "   Requires sudo."
    echo "   Add /usr/local/bin/bash to /etc/shells."
    echo "4. Update default shell."
    echo "   chsh -s /usr/local/bin/bash $USER"
    echo "5. Reload the shell and check bash version."
    echo '   echo $BASH_VERSION'
    return 1
fi

CMD="$1"

export KOOPA_VERSION="0.2.2"
export KOOPA_DATE="2018-12-19"

export KOOPA_EXE="${BASH_SOURCE[0]}"
export KOOPA_BIN_DIR="$( dirname "$KOOPA_EXE" )"
export KOOPA_BASE_DIR="$( dirname "$KOOPA_BIN_DIR" )"
export KOOPA_FUNCTIONS_DIR="${KOOPA_BASE_DIR}/functions"
export KOOPA_SYSTEM_DIR="${KOOPA_BASE_DIR}/system"

# Source our functions that don't get exported to PATH.
# Do this first because the downstream code depends on these.
for file in "${KOOPA_FUNCTIONS_DIR}/"*
do
    source "$file"
done

if [[ "$CMD" == "activate" ]]; then
    source "${KOOPA_SYSTEM_DIR}/activate.sh"
elif [[ "$CMD" == "info" ]]; then
    source "${KOOPA_SYSTEM_DIR}/info.sh"
elif [[ "$CMD" == "list" ]]; then
    source "${KOOPA_SYSTEM_DIR}/list.sh"
else
    echo "koopa args: activate, info, list"
    exit 1
fi

unset -v CMD
