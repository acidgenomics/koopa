#!/usr/bin/env bash
set -Eeu -o pipefail

if [[ -z "${KOOPA_PREFIX:-}" ]]
then
    KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
        >/dev/null 2>&1 && pwd -P)"
    # shellcheck source=/dev/null
    force=1 minimal=1 . "${KOOPA_PREFIX}/activate"
fi
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"
_koopa_assert_has_args "$@"

include_dir="${KOOPA_PREFIX}/system/include/koopa"

case "$1" in
    --help|-h)
        usage
        exit 0
        ;;
    --version|-V)
        version="$(_koopa_variable koopa)"
        date="$(_koopa_variable koopa_date)"
        echo "koopa ${version} (${date})"
        exit 0
        ;;
    app-prefix)
        _koopa_app_prefix
        exit 0
        ;;
    check)
        "${include_dir}/check.sh"
        exit 0
        ;;
    header)
        _koopa_header "${2:-}"
        exit 0
        ;;
    home)
        _koopa_stop "Use 'prefix' instead of 'home'."
        ;;
    host-id)
        _koopa_host_id
        exit 0
        ;;
    info)
        "${include_dir}/info.sh"
        exit 0
        ;;
    list)
        "${include_dir}/list.sh"
        exit 0
        ;;
    make-prefix)
        _koopa_make_prefix
        exit 0
        ;;
    os-string)
        _koopa_os_string
        exit 0
        ;;
    prefix)
        _koopa_prefix
        exit 0
        ;;
    update)
        shift 1
        "${include_dir}/update.sh" "$@"
        exit 0
        ;;
    upgrade)
        _koopa_stop "Use 'update' instead of 'upgrade'."
        ;;
    variable)
        _koopa_variable "$2"
        exit 0
        ;;
    *)
        _koopa_invalid_arg "$1"
        ;;
esac
