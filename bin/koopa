#!/usr/bin/env bash
set -Eeu -o pipefail

# koopa shell bootloader.
# (c) 2018 Michael Steinbaugh.
# This software is provided under an MIT License.

version="0.4.0a"
date="2019-06-20"

if [[ -z "${KOOPA_SHELL:-}" ]]
then
    >&2 printf "koopa is not correctly activated.\n"
    >&2 printf "Source the 'activate' script in your shell configuration.\n"
    exit 1
fi

# Source internal functions.
. "${KOOPA_DIR}/system/include/functions.sh"

script_dir="${KOOPA_DIR}/system/koopa"

usage() {
    cat "${script_dir}/usage.txt"
}

[ -z "${1:-}" ] && usage && exit 0

case "$1" in
    --help|-h)
        usage
        exit 0
        ;;
    --version|-V)
        printf "koopa %s (%s)\n" "$version" "$date"
        exit 0
        ;;
    check)
        Rscript --vanilla "${script_dir}/check.R"
        exit 0
        ;;
    info)
        "${script_dir}/info.sh"
        exit 0
        ;;
    list)
        Rscript --vanilla "${script_dir}/list.R"
        exit 0
        ;;
    update)
        "${script_dir}/update.sh"
        exit 0
        ;;
    upgrade)
        >&2 printf "Error: Use 'update' instead of 'upgrade'.\n"
        exit 1
        ;;
    variable)
        koopa_variable "$2"
        exit 0
        ;;
    *)
        >&2 printf "Error: Unsupported command.\n"
        exit 1
        ;;
esac
