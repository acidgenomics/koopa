#!/usr/bin/env bash

if [[ -z "${KOOPA_HOME:-}" ]]
then
    KOOPA_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
        >/dev/null 2>&1 && pwd -P)"
    # shellcheck source=/dev/null
    force=1 minimal=1 . "${KOOPA_HOME}/activate"
fi

# shellcheck source=/dev/null
source "${KOOPA_HOME}/shell/bash/include/header.sh"

version="$(_koopa_variable koopa)"
date="$(_koopa_variable koopa_date)"



# Usage                                                                     {{{1
# ==============================================================================

usage() {
    cat << EOF
$(_koopa_help_header) [--version|-V]
    COMMAND

koopa $version ($date)
Shell bootloader for bioinformatics.

system configuration commands:
    check
        Run system dependency version checks.
    info
        Show system information.
    list
        List programs accessible in "\$PATH".
    update
        Update koopa installation to latest version.

return string commands:
    header
        Shell script header.
    home
        Return the koopa installation path.
        Also stored as 'KOOPA_HOME' environment variable.
    variable
        Internal koopa configuration variable.
        For use in Python and R scripts only.

optional arguments:
    --help, -h
        Show this help message and exit.
    --version, -V
        Version information.

note:
    This software is provided under an MIT License.
    See 'LICENSE' file for details.
EOF
}

[[ -z "${1:-}" ]] && usage && exit 0



# Parse arguments                                                           {{{1
# ==============================================================================

include_dir="${KOOPA_HOME}/system/include/koopa"

case "$1" in
    --help|-h)
        usage
        exit
        ;;
    --version|-V)
        printf "koopa %s (%s)\n" "$version" "$date"
        exit
        ;;
    check)
        Rscript --vanilla "${include_dir}/check.R"
        exit
        ;;
    header)
        _koopa_header "${2:-}"
        exit
        ;;
    home)
        _koopa_home
        exit
        ;;
    host-type)
        _koopa_host_type
        exit
        ;;
    info)
        "${include_dir}/info.sh"
        exit
        ;;
    list)
        Rscript --vanilla "${include_dir}/list.R"
        exit
        ;;
    os-type)
        _koopa_os_type
        exit
        ;;
    prompt-conda)
        _koopa_prompt_conda
        exit
        ;;
    prompt-git)
        _koopa_prompt_git
        exit
        ;;
    prompt-venv)
        _koopa_prompt_venv
        exit
        ;;
    update)
        "${include_dir}/update.sh"
        exit
        ;;
    upgrade)
        >&2 printf "Error: Use 'update' instead of 'upgrade'.\n"
        exit 1
        ;;
    variable)
        _koopa_variable "$2"
        exit
        ;;
    *)
        >&2 printf "Error: Unsupported command: '%s'\n" "$1"
        exit 1
        ;;
esac
