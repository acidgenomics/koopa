#!/usr/bin/env bash
set -Eeu -o pipefail

script_path="${BASH_SOURCE[0]}"
if [ -L "$script_path" ]
then
    _koopa_realpath() {
        if [ "$(uname -s)" = "Darwin" ]
        then
            perl -MCwd -e 'print Cwd::abs_path shift' "$1"
        else
            readlink -f "$@"
        fi
    }
    script_path="$(_koopa_realpath "$script_path")"
fi
script_dir="$(cd "$(dirname "$script_path")" &>/dev/null && pwd -P)"
# shellcheck source=/dev/null
checks=0 source "${script_dir}/../shell/bash/include/header.sh"
_koopa_assert_has_args "$@"

koopa_prefix="$(_koopa_prefix)"
include_dir="${koopa_prefix}/system/include/koopa"

case "$1" in
    # Standard flags {{{1
    # ==========================================================================
    # Note that '--help|-h' flags are supported by Bash header script.
    --version|-V|version)
        shift 1
        _koopa_assert_has_no_args "$@"
        _koopa_version
        exit 0
        ;;
    # System configuration {{{1
    # ==========================================================================
    check|check-system)
        shift 1
        # shellcheck disable=SC1090
        source "${include_dir}/check-system.sh" "$@"
        exit 0
        ;;
    header)
        shift 1
        _koopa_header "$@"
        exit 0
        ;;
    info)
        shift 1
        # shellcheck disable=SC1090
        source "${include_dir}/info.sh" "$@"
        exit 0
        ;;
    list)
        shift 1
        # shellcheck disable=SC1090
        source "${include_dir}/list.sh" "$@"
        exit 0
        ;;
    list-internal|list-internal-functions)
        shift 1
        _koopa_assert_has_no_args "$@"
        _koopa_list_internal_functions
        exit 0
        ;;
    pull)
        shift 1
        _koopa_system_git_pull "$@"
        exit 0
        ;;
    set-permissions)
        shift 1
        _koopa_set_permissions "$@"
        exit 0
        ;;
    test)
        shift 1
        "${koopa_prefix}/tests/ci.sh" "$@"
        exit 0
        ;;
    uninstall)
        shift 1
        "${koopa_prefix}/uninstall" "$@"
        exit 0
        ;;
    update)
        shift 1
        # shellcheck disable=SC1090
        source "${include_dir}/update.sh" "$@"
        exit 0
        ;;
    # Installers {{{1
    # ==========================================================================
    install-dotfiles)
        shift 1
        _koopa_git_clone_dotfiles "$@"
        _koopa_install_dotfiles "$@"
        exit 0
        ;;
    install-mike)
        shift 1
        _koopa_install_mike "$@"
        exit 0
        ;;
    # Strings {{{1
    # ==========================================================================
    app-prefix)
        shift 1
        _koopa_assert_has_no_args "$@"
        _koopa_app_prefix
        exit 0
        ;;
    cellar-prefix)
        shift 1
        _koopa_assert_has_no_args "$@"
        _koopa_cellar_prefix
        exit 0
        ;;
    config-prefix)
        shift 1
        _koopa_assert_has_no_args "$@"
        _koopa_config_prefix
        exit 0
        ;;
    get-homebrew-cask-version)
        shift 1
        _koopa_get_homebrew_cask_version "$@"
        exit 0
        ;;
    get-macos-app-version)
        shift 1
        _koopa_get_macos_app_version "$@"
        exit 0
        ;;
    get-version)
        shift 1
        _koopa_get_version "$@"
        exit 0
        ;;
    host-id)
        shift 1
        _koopa_assert_has_no_args "$@"
        _koopa_host_id
        exit 0
        ;;
    local-app-prefix)
        shift 1
        _koopa_assert_has_no_args "$@"
        _koopa_local_app_prefix
        exit 0
        ;;
    make-prefix)
        shift 1
        _koopa_assert_has_no_args "$@"
        _koopa_make_prefix
        exit 0
        ;;
    os-string)
        shift 1
        _koopa_assert_has_no_args "$@"
        _koopa_os_string
        exit 0
        ;;
    prefix)
        shift 1
        _koopa_assert_has_no_args "$@"
        _koopa_prefix
        exit 0
        ;;
    r-home)
        shift 1
        _koopa_assert_has_no_args "$@"
        _koopa_r_home
        exit 0
        ;;
    which-realpath)
        shift 1
        _koopa_which_realpath "$@"
        exit 0
        ;;
    # Developer tools {{{1
    # ==========================================================================
    log)
        shift 1
        _koopa_assert_has_no_args "$@"
        _koopa_view_latest_tmp_log_file
        exit 0
        ;;
    variable)
        shift 1
        _koopa_variable "$@"
        exit 0
        ;;
    variables)
        shift 1
        _koopa_assert_has_no_args "$@"
        vim "${koopa_prefix}/system/include/variables.txt"
        exit 0
        ;;
    # Deprecated args / error catching {{{1
    # ==========================================================================
    help)
        _koopa_defunct "koopa --help"
        ;;
    home)
        _koopa_defunct "koopa prefix"
        ;;
    update-r-config)
        _koopa_defunct "update-r-config (without 'koopa' prefix)"
        ;;
    upgrade)
        _koopa_defunct "koopa update"
        ;;
    *)
        _koopa_invalid_arg "$1"
        ;;
esac
