#!/usr/bin/env bash

KOOPA_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_HOME}/shell/bash/include/header.sh"
_koopa_assert_has_no_envs

anaconda=0

while (("$#"))
do
    case "$1" in
        --anaconda)
            anaconda=1
            shift 1
            ;;
        *)
            _koopa_invalid_arg "$1"
            ;;
    esac
done

if [[ "$anaconda" -eq 1 ]]
then
    name="anaconda3"
    # Or get the current Anaconda installer version automatically.
    # https://www.anaconda.com/distribution/#linux
    # https://www.anaconda.com/distribution/#macos
    version="$(_koopa_variable "$name")"
else
    name="miniconda3"
fi

prefix="$(_koopa_app_prefix)/conda"
tmp_dir="$(_koopa_tmp_dir)/${name}"
exe_file="${prefix}/bin/conda"

_koopa_message "Installing Conda at '${prefix}'."

if [[ ! -L "$prefix" ]]
then
    _koopa_prefix_mkdir "$prefix"
fi

if [[ "$anaconda" -eq 1 ]]
then
    case "$OSTYPE" in
        linux-gnu)
            script="Anaconda3-${version}-Linux-x86_64.sh"
            ;;
        darwin*)
            script="Anaconda3-${version}-MacOSX-x86_64.sh"
            ;;
        *)
            _koopa_stop "'${OSTYPE}' is not supported."
            ;;
    esac
    (
        rm -fr "$tmp_dir"
        mkdir -p "$tmp_dir"
        cd "$tmp_dir" || exit 1
        _koopa_download "https://repo.anaconda.com/archive/${script}"
        bash "$script" -bf -p "$prefix"
        rm -fr "$tmp_dir"
    )
else
    case "$OSTYPE" in
        linux-gnu)
            script="Miniconda3-latest-Linux-x86_64.sh"
            ;;
        darwin*)
            script="Miniconda3-latest-MacOSX-x86_64.sh"
            ;;
        *)
            _koopa_stop "'${OSTYPE}' is not supported."
            ;;
    esac
    (
        rm -rf "$tmp_dir"
        mkdir -p "$tmp_dir"
        cd "$tmp_dir" || exit 1
        _koopa_download "https://repo.continuum.io/miniconda/${script}"
        bash "$script" -bf -p "$prefix"
        rm -rf "$tmp_dir"
    )
fi

ln -fnsv "${KOOPA_HOME}/os/linux/etc/conda/condarc" \
    "${prefix}/.condarc"

_koopa_set_permissions "$prefix"

command -v "$exe_file"
"$exe_file" --version
