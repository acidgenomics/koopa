#!/usr/bin/env bash

KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"

_koopa_exit_if_installed conda
_koopa_assert_has_no_envs

anaconda=0

while (("$#"))
do
    case "$1" in
        --anaconda)
            anaconda=1
            shift 1
            ;;
        *)
            _koopa_invalid_arg "$1"
            ;;
    esac
done

if [[ "$anaconda" -eq 1 ]]
then
    name="anaconda3"
    version="$(_koopa_variable "$name")"
else
    name="miniconda3"
fi

prefix="$(_koopa_conda_prefix)"
_koopa_exit_if_dir "$prefix"

_koopa_h1 "Installing Conda at '${prefix}'."

_koopa_mkdir "$prefix"
tmp_dir="$(_koopa_tmp_dir)"

(
    _koopa_cd_tmp_dir "$tmp_dir"
    case "$name" in
        anaconda3)
            case "${OSTYPE:?}" in
                darwin*)
                    script="Anaconda3-${version}-MacOSX-x86_64.sh"
                    ;;
                linux*)
                    script="Anaconda3-${version}-Linux-x86_64.sh"
                    ;;
                *)
                    _koopa_stop "'${OSTYPE}' is not supported."
                    ;;
            esac
            url="https://repo.anaconda.com/archive/${script}"
            ;;
        miniconda3)
            # Note that versioned script for v4.8+ currently isn't available.
            case "${OSTYPE:?}" in
                darwin*)
                    script="Miniconda3-latest-MacOSX-x86_64.sh"
                    ;;
                linux*)
                    script="Miniconda3-latest-Linux-x86_64.sh"
                    ;;
                *)
                    _koopa_stop "'${OSTYPE}' is not supported."
                    ;;
            esac
            url="https://repo.continuum.io/miniconda/${script}"
            ;;
    esac
    _koopa_download "$url"
    bash "$script" -bf -p "$prefix"
) 2>&1 | tee "$(_koopa_tmp_log_file)"

rm -fr "$tmp_dir"

ln -fnsv "$(_koopa_prefix)/os/linux/etc/conda/condarc" \
    "${prefix}/.condarc"

_koopa_remove_broken_symlinks "$prefix"
_koopa_set_permissions --recursive "$prefix"

set +u
_koopa_activate_conda
set -u

if [[ "$name" == "miniconda3" ]]
then
    update-conda
fi

_koopa_install_success "conda"
_koopa_restart
