#!/usr/bin/env bash
set -Eeu -o pipefail

# shellcheck source=/dev/null
source "$(koopa header bash)"

# Find build cellar symbolic links.
# Updated 2019-06-26.

name="$1"
version="$2"

build_prefix="$(_koopa_build_prefix)"
cellar_prefix="$(_koopa_cellar_prefix)/${name}/${version}"

array=()
while IFS=  read -r -d $'\0'; do
    array+=("$REPLY")
done < <( \
    find -L \
    "$build_prefix" \
    -type f \
    -path "${cellar_prefix}/*" \
    ! -path "${build_prefix}/koopa" \
    -print0
)

# Sort the array.
IFS=$'\n' mapfile -t array < <(sort <<<"${array[*]}")
unset IFS

for file in "${array[@]}"
do
    # Replace the cellar prefix with our build prefix.
    echo "${file//$cellar_prefix/$build_prefix}"
done
