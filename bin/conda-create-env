#!/usr/bin/env bash
set -Eeu -o pipefail

KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"

_koopa_assert_has_args "$@"
_koopa_assert_is_installed conda

force=0

POSITIONAL=()
while (("$#"))
do
    case "$1" in
        --force)
            force=1
            shift 1
            ;;
        --)
            shift 1
            break
            ;;
        --*|-*)
            _koopa_invalid_arg "$1"
            ;;
        *)
            POSITIONAL+=("$1")
            shift 1
            ;;
    esac
done
set -- "${POSITIONAL[@]}"

name="$1"

prefix="$(_koopa_conda_default_envs_prefix)/${name}"

if [[ "$force" -eq 1 ]]
then
    conda remove --name "$name" --all
else
    _koopa_exit_if_dir "$prefix"
fi

_koopa_info "Creating '${name}' conda environment."

conda create -qy --name="$name" "$name"
_koopa_set_permissions "$prefix"
