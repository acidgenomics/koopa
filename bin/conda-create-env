#!/usr/bin/env bash
set -Eeu -o pipefail

KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"

_koopa_assert_has_args "$@"
_koopa_assert_is_installed conda

force=0
version=

pos=()
while (("$#"))
do
    case "$1" in
        --force)
            force=1
            shift 1
            ;;
        --version=*)
            version="${1#*=}"
            shift 1
            ;;
        --version)
            version="$2"
            shift 2
            ;;
        --)
            shift 1
            break
            ;;
        --*|-*)
            _koopa_invalid_arg "$1"
            ;;
        *)
            pos+=("$1")
            shift 1
            ;;
    esac
done
set -- "${pos[@]}"

name="$1"

if [[ -n "${version:-}" ]]
then
    env_name="${name}@${version}"
else
    env_name="$name"
fi

prefix="$(_koopa_conda_default_envs_prefix)/${env_name}"

if [[ "$force" -eq 1 ]]
then
    conda remove --name "$env_name" --all
else
    _koopa_exit_if_dir "$prefix"
fi

_koopa_info "Creating '${env_name}' conda environment."

flags=(
    "--name=${env_name}"
    "--quiet"
    "--yes"
)

if [[ -n "${version:-}" ]]
then
    flags+=("${name}=${version}")
else
    flags+=("$name")
fi

conda create "${flags[@]}"

_koopa_set_permissions "$prefix"
