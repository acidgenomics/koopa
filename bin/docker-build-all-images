#!/usr/bin/env bash
set -Eeu -o pipefail

KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"

# """
# Build all Acid Genomics images.
# Updated 2020-02-18.
#
# Skipping any image that has been built today.
# """

_koopa_h1 "Building all Docker images."

docker login

images=(
    # Lightweight Linux images.
    acidgenomics/biocontainers
    acidgenomics/kali
    acidgenomics/miniconda3
    # Full Linux images.
    acidgenomics/alpine
    acidgenomics/amzn
    acidgenomics/arch
    acidgenomics/centos
    acidgenomics/debian
    acidgenomics/fedora
    acidgenomics/opensuse
    acidgenomics/ubuntu
    # R images.
    acidgenomics/bioconductor
    acidgenomics/basejump
    acidgenomics/bcbiornaseq
    acidgenomics/bcbiosinglecell
    acidgenomics/rnaseq
    acidgenomics/singlecell
    # Bioinformatics software.
    # > acidgenomics/rnaeditingindexer
    # > acidgenomics/maestro
)

docker system prune --all --force

for image in "${images[@]}"
do
    # Skip image if pushed already today.
    docker pull "$image"
    json="$( \
        docker inspect \
        --format='{{json .Created}}' \
        "$image" \
    )"
    # Note that we need to convert UTC to local time.
    utc_timestamp="$( \
        echo "$json" \
            | grep -Eo '[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}' \
            | sed 's/T/ /' \
            | sed 's/$/ UTC/'
    )"
    timestamp="$(date -d "$utc_timestamp" '+%Y-%m-%d')"
    today=$(date '+%Y-%m-%d')
    if [[ "$timestamp" == "$today" ]]
    then
        _koopa_note "'${image}' image already pushed today."
        continue
    fi

    # Build outdated images automatically.
    docker-build-all-tags "$image"
    docker system prune --all --force
done

_koopa_success "All Docker images built successfully."
