#!/usr/bin/env bash
set -Eeu -o pipefail

KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"

# """
# Build all Acid Genomics images.
# Updated 2020-02-18.
#
# Skipping any image that has been built today.
# """

_koopa_h1 "Building all Docker images."

docker login

# Nuclear reset option.
# > docker system prune --all --force

images=(
    # Lightweight Linux images.
    acidgenomics/alpine
    acidgenomics/amzn
    acidgenomics/arch
    acidgenomics/biocontainers
    acidgenomics/kali
    acidgenomics/miniconda3
    acidgenomics/opensuse
    # Full Linux images.
    acidgenomics/debian
    acidgenomics/ubuntu
    acidgenomics/fedora
    acidgenomics/centos
    # R images.
    acidgenomics/bioconductor
    acidgenomics/basejump
    acidgenomics/bcbiornaseq
    acidgenomics/bcbiosinglecell
    acidgenomics/rnaseq
    # > acidgenomics/singlecell
    # Bioinformatics software.
    # > acidgenomics/rnaeditingindexer
    # > acidgenomics/maestro
)

for image in "${images[@]}"
do
    # Force remove existing local image(s).  {{{2
    mapfile -t image_ids < <( \
        docker image ls \
            --filter reference="$image" \
            --quiet \
    )
    if _koopa_is_array_non_empty "${image_ids[@]}"
    then
        _koopa_note "Existing local copy of '${image}' detected. Removing."
        docker image rm --force "${image_ids[@]}"
    fi

    docker pull "$image"

    # Skip image if built today.  {{{2
    json="$( \
        docker inspect \
        --format='{{json .Created}}' \
        "$image" \
    )"
    timestamp="$( \
        echo "$json" \
            | grep -Eo '[0-9]{4}-[0-9]{2}-[0-9]{2}' \
    )"
    today=$(date "+%Y-%m-%d")
    if [[ "$timestamp" == "$today" ]]
    then
        _koopa_note "'${image}' image already built today."
        continue
    fi

    docker-build "$image"
done

_koopa_success "All Docker images built successfully."
