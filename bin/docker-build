#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../shell/bash/include/header.sh"

# """
# Build and push a docker image.
# Updated 2020-06-02.
#
# Use '--no-cache' flag to disable build cache.
#
# Examples:
# docker-build-image bioconductor release
# docker-build fedora
#
# See also:
# - docker build --help
# - https://docs.docker.com/engine/reference/builder/#arg
# """

# e.g. ~/.config/koopa/docker
docker_dir="$(_koopa_docker_prefix)"
_koopa_assert_is_dir "$docker_dir"

push=1
server="docker.io"
tag="latest"

pos=()
while (("$#"))
do
    case "$1" in
        --no-push)
            push=0
            shift 1
            ;;
        --server=*)
            server="${1#*=}"
            shift 1
            ;;
        --server)
            server="$2"
            shift 2
            ;;
        --tag=*)
            tag="${1#*=}"
            shift 1
            ;;
        --tag)
            tag="$2"
            shift 2
            ;;
        --)
            shift 1
            break
            ;;
        --*|-*)
            _koopa_invalid_arg "$1"
            ;;
        *)
            pos+=("$1")
            shift 1
            ;;
    esac
done
[[ "${#pos[@]}" -gt 0 ]] && set -- "${pos[@]}"

# e.g. acidgenomics/debian
image="${1:?}"

# Assume acidgenomics recipe by default.
if ! _koopa_str_match "$image" "/"
then
    image="acidgenomics/${image}"
fi

# Handle tag support, if necessary.
if _koopa_str_match "$image" ":"
then
    tag="$(_koopa_print "$image" | cut -d ':' -f 2)"
    image="$(_koopa_print "$image" | cut -d ':' -f 1)"
fi

source_image="${docker_dir}/${image}/${tag}"
_koopa_assert_is_dir "$source_image"
if [[ -L "$source_image" ]]
then
    _koopa_stop "Symlink at '${source_image}'. Use directory instead."
fi

# e.g. acidgenomics/debian:latest
tagged_image="${image}:${tag}"
today=$(date "+%Y%m%d")
# e.g. acidgenomics/debian:latest-20200101
tagged_image_today="${tagged_image}-${today}"

_koopa_h1 "Building '${tagged_image}' Docker image."

docker login "$server"

# Force remove any existing local tagged images.
readarray -t image_ids <<< "$( \
    docker image ls \
        --filter reference="$tagged_image" \
        --quiet \
)"
if _koopa_is_array_non_empty "${image_ids[@]}"
then
    docker image rm --force "${image_ids[@]}"
fi

# Build a local copy of the image.
docker build \
    --build-arg "GITHUB_PAT=${DOCKER_GITHUB_PAT:?}" \
    --no-cache \
    --tag="$tagged_image_today" \
    "$source_image"

docker tag "$tagged_image_today" "$tagged_image"

if [[ "$push" -eq 1 ]]
then
    docker push "${server}/${tagged_image_today}"
    docker push "${server}/${tagged_image}"
fi

docker image ls \
    --filter reference="$tagged_image"

_koopa_success "Build of '${tagged_image}' was successful."
