#!/usr/bin/env bash

KOOPA_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_HOME}/shell/bash/include/header.sh"



# Notes                                                                     {{{1
# ==============================================================================

# Remove duplicate lines.
# Note that awk is significantly faster than sort for large files.
# https://stackoverflow.com/questions/9377040
# > sort -u tx2gene.csv

# Outputting as CSV instead of TSV.
# > paste -d "," \
# >     <(cut -d '>' -f2 .t2g1 | cut -d ' ' -f1) \
# >     <(cut -d ' ' -f2 .t2g1 | cut -d ':' -f2) >> \
# >     .t2g2



# Variables                                                                 {{{1
# ==============================================================================

output_file="tx2gene.csv"



# Usage                                                                     {{{1
# ==============================================================================

usage() {
cat << EOF
$(_koopa_help_header)
    fasta_file [output_file="${output_file}"]

Generate transcript-to-gene mappings from Ensembl FASTA.

required positional arguments:
    1.  Transcriptome FASTA file.
        Assuming input FASTA is gzip compressed.

optional positional arguments with defaults:
    2.  Output CSV file.
        Defaults to '${output_file}'.

$(_koopa_help_args)

details:
    Generates a CSV mapping file from the reference transcriptome input,
        suitable for use with 'tximport()' in R.
    Output does not contain column names.
    Transcript and gene identifier versions are maintained.

    Column 1: transcripts
    Column 2: genes
 
    Internal processing steps:
    1. Decompress FASTA and pipe to stdout.
    2. Keep only headers prefixed with '>'.
    3. Keep only transcript (1) and gene (4) identifier columns.
    4. Remove duplicate lines.
    5. Trim header prefix '>'.
    6. Prepare ',' delim for CSV output.
    7. Write to '${output_file}'.

    Ensembl GTF files do not contain complete transcript-to-gene mappings.
    This is particularly an issue for the Homo sapiens reference genome.

see also:
    Modified version of @ag1805x script.
    - https://support.bioconductor.org/p/123134/
    - https://gist.github.com/ag1805x/63007cf0ba20b078d6d3c849064a1bff

note:
    Bash script.
    Updated 2019-10-11.
EOF
}

[[ -z "$*" ]] && usage && exit 0
_koopa_help "$@"



# Arguments                                                                 {{{1
# ==============================================================================

fasta_file="$1"
output_file="${2:-$output_file}"



# Script                                                                    {{{1
# ==============================================================================

printf "Generating '%s' from '%s'.\n" \
    "$(basename "$output_file")" \
    "$(basename "$fasta_file")"

_koopa_assert_is_not_file "$output_file"
_koopa_assert_matches_pattern "$fasta_file" ".cdna.all.fa.gz"

gunzip -c "$fasta_file" | \
    grep '>' | \
    cut -d ' ' -f1,4 | \
    awk '!a[$0]++' | \
    tr -d '>' | \
    sed -E 's/ [a-z]+:/,/g' > \
    "$output_file"

# Return the number of transcripts.
count="$(_koopa_line_count "$output_file")"
printf "%d transcripts detected.\n" "$count"
