#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../shell/bash/include/header.sh"

_koopa_assert_has_args "$#"

fasta_file="$1"
_koopa_assert_is_file "$fasta_file"
_koopa_assert_is_matching_fixed "$fasta_file" ".cdna.all.fa.gz"

output_file="${2:-"tx2gene.csv"}"
_koopa_assert_is_not_file "$output_file"

_koopa_h1 "Generating '$(basename "$output_file")' from \
'$(basename "$fasta_file")'."

gunzip -c "$fasta_file" \
    | grep '>' \
    | cut -d ' ' -f1,4 \
    | awk '!a[$0]++' \
    | tr -d '>' \
    | sed -E 's/ [a-z]+:/,/g' \
    > "$output_file"

# Return the number of transcripts.
count="$(_koopa_line_count "$output_file")"
_koopa_h1 "${count} transcripts detected."
