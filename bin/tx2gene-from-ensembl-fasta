#!/usr/bin/env bash

KOOPA_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_HOME}/shell/bash/include/header.sh"



# Usage                                                                     {{{1
# ==============================================================================

usage() {
cat << EOF
$(_koopa_help_header)
    fasta_file

Generate transcript-to-gene mappings from Ensembl FASTA.

details:
    Ensembl GTF files do not contain complete transcript-to-gene mappings.
    This is particularly an issue for Homo sapiens reference genome.

    This script generates a complete tx2gene.csv mapping file from the reference
    transcriptome input instead, suitable for use with 'tximport()' in R.

    Assumes input FASTA is gzip compressed.

see also:
    - https://support.bioconductor.org/p/123134/

note:
    Bash script.
    Updated 2019-10-04.
EOF
}

[[ -z "$*" ]] && usage && exit 0
_koopa_help "$@"



# Arguments                                                                 {{{1
# ==============================================================================

fasta="$1"



# Script                                                                    {{{1
# ==============================================================================

# Check for expected input.
pattern=".cdna.all.fa.gz"
if ! echo "$fasta" | grep -q "$pattern"
then
    >&2 printf "Error: Not Ensembl transcriptome FASTA: '%s'.\n" "$fasta"
    exit 1
fi

# Use of 7 here will include gene symbol.
zcat "$fasta" | \
    grep '>' | \
    cut -d ' ' -f1,4 > \
    .t2g

# Note that paste defaults to tab delimiters.
paste -d "," \
    <(cut -d '>' -f2 .t2g | cut -d ' ' -f1) \
    <(cut -d ' ' -f2 .t2g | cut -d ':' -f2) >> \
    tx2gene.csv

rm .t2g
