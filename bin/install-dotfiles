#!/usr/bin/env bash
set -Eeu -o pipefail

KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"

while (("$#"))
do
    case "$1" in
        --mike)
            mike=1
            shift 1
            ;;
        *)
            _koopa_invalid_arg "$1"
            ;;
    esac
done

# dotfiles                                                                  {{{1
# ==============================================================================

source_repo="${1:-"https://github.com/mjsteinbaugh/dotfiles.git"}"
target_dir="$(_koopa_prefix)/dotfiles"

if [[ -d "$target_dir" ]]
then
    _koopa_success "Dotfiles are already installed at '${target_dir}'."
else
    _koopa_h1 "Installing dotfiles into '${target_dir}'."
    git clone --recursive "$source_repo" "$target_dir"
    if [[ -x "${target_dir}/INSTALL.sh" ]]
    then
        "${target_dir}/INSTALL.sh"
    fi
fi

if [[ "$mike" -eq 1 ]]
then
    (
        cd "$target_dir" || exit 1
        git remote set-url origin "git@github.com:mjsteinbaugh/dotfiles.git"
    )
fi

# dotfiles-private                                                          {{{1
# ==============================================================================

if [[ "$mike" -eq 1 ]]
then
    source_repo="git@github.com:mjsteinbaugh/dotfiles-private.git"
    target_dir="$(_koopa_config_prefix)/dotfiles-private"
    if [[ -d "$target_dir" ]]
    then
        _koopa_success "Dotfiles are already installed at '${target_dir}'."
    else
        git clone --recursive "$source_repo" "$target_dir"
        if [[ -x "${target_dir}/INSTALL.sh" ]]
        then
            "${target_dir}/INSTALL.sh"
        fi
    fi
fi
