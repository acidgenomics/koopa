#!/usr/bin/env bash
set -Eeu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../include/header.sh"

_koopa_assert_has_no_envs
_koopa_assert_is_installed pipx python3

_koopa_h1 "Installing pipx virtual environments."
_koopa_dl "PIPX_HOME" "$PIPX_HOME"
_koopa_dl "PIPX_BIN_DIR" "$PIPX_BIN_DIR"

mkdir -pv "$PIPX_BIN_DIR"
_koopa_add_to_path_start "$PIPX_BIN_DIR"

envs=(
    black
    flake8
    pyflakes
    pylint
    pytest
)

_koopa_dl "Environments" "$(_koopa_to_string "${envs[@]}")"

# Can pass '--force' flag here to force reinstall.
for env in "${envs[@]}"
do
    _koopa_h2 "Installing '${env}'."
    rm -fr "${PIPX_HOME}/venvs/${env}"
    (
        set -o xtrace
        pipx install --force "$env"
    ) &> "$(_koopa_tmp_log_file)"
done

_koopa_set_permissions "$PIPX_HOME"

_koopa_success "pipx environments installed successfully."
_koopa_note "Restart the shell to ensure programs are available in PATH."
