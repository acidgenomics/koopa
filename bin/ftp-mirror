#!/usr/bin/env bash
set -Eeu -o pipefail

# shellcheck source=/dev/null
source "$(koopa header bash)"

# Recursively download (mirror) over FTP using wget.
# Updated 2019-07-30.

# For secure transfers, just use rsync or scp instead.

_koopa_assert_is_installed wget



# Usage                                                                     {{{1
# ==============================================================================

# FIXME Rework to use "=" on long flags here.

usage() {
    cat << EOF
usage: ftp-mirror [-h] --host "HOSTNAME" --user "USERNAME" [--dir "REMOTE DIR"]

required arguments:
    --host
        Remote host name (e.g. ftp.acidgenomics.com). Leave out the protocol
        here (e.g. 'ftp://'). We're assuming it's a standard FTP transfer.
    --user
        Remote user name. This script is intended to only perform an
        authenticated transfer. Otherwise you can simply call 'wget' with the
        '--mirror' flag.

optional arguments:
    --dir
        Remote directory path. Note that this script always mirrors to the
        current working directory path on the local machine.
EOF
}



# Parse arguments                                                           {{{1
# ==============================================================================

while (("$#"))
do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        --host)
            host="$2"
            shift 2
            ;;
        --user)
            user="$2"
            shift 2
            ;;
        --)
            # End argument parsing.
            shift
            break
            ;;
        --*|-*)
            # Unsupported flags.
            >&2 printf "Error: Invalid flag '%s'\n" "$1"
            exit 1
            ;;
        *)
            shift
            ;;
    esac
done

if [[ -z "${host:-}" ]] ||
    [[ -z "${user:-}" ]]
then
    >&2 printf "Error: Missing required argument.\n\n"
    usage
    exit 1
fi

unset -f usage



# Run script                                                                {{{1
# ==============================================================================

if [[ -n "${dir:-}" ]]
then
    path="${host}/${dir}"
else
    path="${host}"
fi

wget \
    --ask-password \
    --mirror \
    "ftp://${user}@${path}/"*
