#!/usr/bin/env bash
set -Eeu -o pipefail

# shellcheck source=/dev/null
source "$(koopa header bash)"



# Usage                                                                     {{{1
# ==============================================================================

usage() {
    cat << EOF
usage: ftp-mirror [-h] --host="HOST" --user="USER" [--dir="DIR"]

Recursively download (mirror) over FTP using wget.

required arguments:
    --host
        Remote host name (e.g. ftp.acidgenomics.com). Leave out the protocol
        here (e.g. 'ftp://'). We're assuming it's a standard FTP transfer.
    --user
        Remote user name. This script is intended to only perform an
        authenticated transfer. Otherwise you can simply call 'wget' with the
        '--mirror' flag.

optional arguments:
    --dir
        Remote directory path. Note that this script always mirrors to the
        current working directory path on the local machine.

details:
    For secure transfers, just use rsync or scp instead.

note:
    Bash script.
    Updated 2019-07-30.
EOF
}



# Parse arguments                                                           {{{1
# ==============================================================================

for i in "$@"
do
    case "$i" in
        --help|-h)
            usage
            exit 0
            ;;
        --host=*)
            host="${i#*=}"
            shift
            ;;
        --user=*)
            user="${i#*=}"
            shift
            ;;
        --)
            # End argument parsing.
            shift
            break
            ;;
        --*|-*)
            # Invalid argument.
            >&2 printf "Error: Invalid argument: '%s'\n" "$i"
            exit 1
            ;;
        *)
            shift
            ;;
    esac
done

if [[ -z "${host:-}" ]] ||
    [[ -z "${user:-}" ]]
then
    >&2 printf "Error: Missing argument.\n\n"
    usage
    exit 1
fi



# Script                                                                    {{{1
# ==============================================================================

_koopa_assert_is_installed wget

if [[ -n "${dir:-}" ]]
then
    path="${host}/${dir}"
else
    path="${host}"
fi

wget --ask-password --mirror "ftp://${user}@${path}/"*
