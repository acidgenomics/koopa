#!/usr/bin/env Rscript

options(
    "error" = quote(quit(status = 1L)),
    "warning" = quote(quit(status = 1L))
)

args <- commandArgs(trailingOnly = FALSE)
whichFile <- grep(pattern = "--file", x = args)
file <- args[whichFile]
file <- sub(pattern = "^--file=", replacement = "", x = file)
koopaPrefix <- normalizePath(dirname(dirname(file)))
source(file.path(koopaPrefix, "lang", "r", "include", "header.R"))

## Remove legacy packages, if necessary.
legacyPkgs <- c(
    "Matrix.utils",
    "ashr",
    "bioverbs",
    "brio"
)
installedPkgs <- rownames(installed.packages())
if (any(legacyPkgs %in% installedPkgs)) {
    message("Removing packages: ", toString(legacyPkgs))
    tryCatch(
        expr = remove.packages(legacyPkgs),
        warning = function(w) {
            invisible()
        },
        error = function(e) {
            invisible()
        }
    )
}

stopifnot(requireNamespace("bb8", quietly = TRUE))
bb8::updatePackages()
