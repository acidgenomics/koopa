#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../shell/bash/include/header.sh"

dir="${1:-"."}"
dir="$(realpath "$dir")"

# Using '-L' flag here in case git dir is a symlink.
readarray -t repos <<< "$( \
    find -L "$dir" \
        -mindepth 1 \
        -maxdepth 2 \
        -name ".git" \
        -print \
)"

if ! koopa::is_array_non_empty "${repos[@]}"
then
    koopa::stop "Failed to detect any git repos."
fi

koopa::h1 "Checking status of ${#repos[@]} git repos recursively at '${dir}'."

for repo in "${repos[@]}"
do
    repo="$(dirname "$repo")"
    koopa::h2 "$(basename "$repo")"
    (
        cd "$repo" || exit 1
        pwd
        git status
    )
done
