#!/usr/bin/env bash
set -Eeu -o pipefail

KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"
_koopa_assert_has_no_args "$@"

url="ftp://ftp.flybase.net/releases/"
dmel=0

while (("$#"))
do
    case "$1" in
        --dmel)
            dmel=1
            shift 1
            ;;
        *)
            _koopa_invalid_arg "$1"
            ;;
    esac
done

if [[ "$dmel" -eq 1 ]]
then
    curl --list-only --silent "${url}current/" | \
        grep -E "^dmel_r[.0-9]+$" | \
        head -n 1 | \
        cut -d "_" -f 2
else
    curl --list-only --silent "$url" | \
        grep -E "^FB[0-9]{4}_[0-9]{2}$" | \
        sort | \
        tail -n 1
fi
