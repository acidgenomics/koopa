#!/usr/bin/env bash

## shellcheck source=/dev/null
source "$(koopa header bash)"

## Copy BAM and BAI index sidecar files to a destination.
## Updated 2019-06-26.

## Source directory.
source_dir="$1"
source_dir="$(realpath "$source_dir")"
if [[ ! -d "$source_dir" ]]
then
    printf "\nDoes not exist:\n%s\n\n" "$source_dir"
    exit 1
fi

## Destination directory.
dest_dir="$2"
dest_dir="$(realpath "$dest_dir")"
if [[ ! -d "$dest_dir" ]]
then
    printf "\nDoes not exist:\n%s\n\n" "$dest_dir"
    exit 1
fi

printf "\nSource:\n%s\n\nDestination:\n%s\n\n" "$source_dir" "$dest_dir"

## Note that we're allowing symlinks in the search path.
## `-L`: Follow symbolic links.

## Note that we're ignoring some bcbio output cruft here.
## Skip transferring any BAM files in the work directory, and don't copy any
## of the transcriptome BAMs automatically.
## Ignore:
## - `work/`
## - `*-transcriptome.bam`

## rsync works more reliably for resuming interrupted transfers.
## Currently using this to transfer to Azure Files, which doesn't support
## the rsync `-av` flags.
## > cp -iruv {} "$dest_dir/".
## > rsync --size-only

find -L "$source_dir" \
    -maxdepth 4 \
    -type f \
    \( -name "*.bam" -or -name "*.bam.bai" \) \
    ! -name "*-transcriptome.bam" \
    ! -path "*/work/*" \
    -print0 | xargs -0 -I {} \
    rsync --size-only --progress {} "${dest_dir}/"
