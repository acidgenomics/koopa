#!/usr/bin/env bash
set -Eeu -o pipefail

KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"

# """
# Useful flags:
# samtools view --help
#
# -1                    use fast BAM compression (implies -b)
# -@, --threads         number of threads
# -C                    output CRAM (requires -T)
# -O, --output-fmt      specify output format (SAM, BAM, CRAM)
# -T, --reference       reference sequence FASTA file
# -b                    output BAM
# -o FILE               output file name [stdout]
# -u                    uncompressed BAM output (implies -b)
# """

delete_sam=0

POSITIONAL=()
while (("$#"))
do
    case "$1" in
        --delete-sam)
            delete_sam=1
            shift 1
            ;;
        --)
            shift 1
            break
            ;;
        --*|-*)
            _koopa_invalid_arg "$1"
            ;;
        *)
            POSITIONAL+=("$1")
            shift 1
            ;;
    esac
done
set -- "${POSITIONAL[@]}"

dir="${1:-.}"
_koopa_assert_is_dir "$dir"
dir="$(realpath "$dir")"

# Pipe GNU find into array.
sam_files=()
while IFS= read -r -d $'\0'
do
    sam_files+=("$REPLY")
done < <( \
    find "$dir" \
        -maxdepth 3 \
        -mindepth 1 \
        -type f \
        -iname "*.sam" \
        -print0 \
    | sort -z \
)

# Error if file array is empty.
if [[ "${#sam_files[@]}" -eq 0 ]]
then
    _koopa_stop "No SAM files detected in '${dir}'."
fi

_koopa_h1 "Converting SAM files in '${dir}' to BAM format."

_koopa_activate_conda_env samtools
_koopa_info "samtools: '$(_koopa_which_realpath samtools)'."

if [[ "$delete_sam" -eq 1 ]]
then
    _koopa_note "SAM files will be deleted."
else
    _koopa_note "SAM files will be preserved."
fi

threads="$(_koopa_cpu_count)"

for sam_file in "${sam_files[@]}"
do
    # FIXME Convert to function.
    bam_file="${sam_file%.sam}.bam"
    sam_bn="$(basename "$sam_file")"
    bam_bn="$(basename "$bam_file")"
    if [[ -f "$bam_file" ]]
    then
        _koopa_note "Skipping '${bam_bn}'."
        continue
    else
        _koopa_info "Converting '${sam_bn}' to '${bam_bn}'."
    fi
    samtools view \
        -@ "$threads" \
        -b \
        -h \
        -o "$bam_file" \
        "$sam_file"
    if [[ "$delete_sam" -eq 1 ]]
    then
        rm -v "$sam_file"
    fi
done
