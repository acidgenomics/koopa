#!/usr/bin/env bash
set -Eeu -o pipefail

# shellcheck source=/dev/null
source "$(koopa header bash)"

# Install recommended Ruby release via rbenv.
# Updated 2019-09-04.

# See also:
# - https://github.com/rbenv/ruby-build
# - https://github.com/rbenv/ruby-build/wiki
# - https://github.com/rbenv/ruby-build/issues/377

_koopa_assert_is_installed rbenv
_koopa_assert_has_no_environments

# > rbenv install -l

version="$(_koopa_variable ruby)"

# Ensure ruby-build is current.
ruby_build_dir="/usr/local/rbenv/plugins/ruby-build"
if [[ -d "$ruby_build_dir" ]]
then
    printf "Updating ruby-build plugin: %s\n" "$ruby_build_dir"
    (
        cd "$ruby_build_dir" || exit 1
        git pull
    )
fi

# Ensure installation uses system OpenSSL.
export RUBY_CONFIGURE_OPTS=--with-openssl-dir=/usr

rbenv install "$version"
rbenv global "$version"

rbenv versions
