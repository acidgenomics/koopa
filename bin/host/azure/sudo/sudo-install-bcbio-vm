#!/usr/bin/env bash
set -Eeu -o pipefail

# Install bcbio-vm.
# Modified 2019-06-14.

# Versioned release images:
# https://quay.io/repository/bcbio/bcbio-vc?tab=tags

# shellcheck source=/dev/null
source "${KOOPA_DIR}/include/host/azure/sudo.sh"

install_dir="/data00/bcbio-vm"
bin_dir="${install_dir}/anaconda/bin"



# Docker                                                                    {{{1
# ==============================================================================

echo "Configuring Docker."
sudo -n groupadd docker
sudo -n service docker restart
sudo -n gpasswd -a "$USER" docker
newgrp docker



# bcbio-vm                                                                  {{{1
# ==============================================================================

echo "Installing bcbio-vm."
wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh -b -p "${install_dir}/anaconda"

"${bin_dir}/conda" install --yes -c conda-forge -c bioconda bcbio-nextgen
"${bin_dir}/conda" install --yes -c conda-forge -c bioconda bcbio-nextgen-vm

rm -f Miniconda3-latest-Linux-x86_64.sh

sudo -n rm -f /usr/local/bin/bcbio_vm.py
sudo -n ln -s "${bin_dir}/bcbio_vm.py" /usr/local/bin/bcbio_vm.py

sudo -n rm -f /usr/local/bin/bcbiovm_conda
sudo -n ln -s "${bin_dir}/conda" /usr/local/bin/bcbiovm_conda

sudo -n chgrp docker /usr/local/bin/bcbio_vm.py
sudo -n chmod g+s /usr/local/bin/bcbio_vm.py

# v1.1.3
data_dir="${install_dir}/v1.1.3"
image="quay.io/bcbio/bcbio-vc:1.1.3-v1.1.3"
bcbio_vm.py --datadir="$data_dir" saveconfig
bcbio_vm.py install --tools --image "$image"

# latest
data_dir="${install_dir}/latest"
image="quay.io/bcbio/bcbio-vc"
bcbio_vm.py --datadir="$data_dir" saveconfig
bcbio_vm.py install --tools --image "$image"
