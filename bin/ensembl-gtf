#!/usr/bin/env python3
"""Download Ensembl genome annotations in GTF format.
"""

# See also:
# - https://docs.python.org/2/howto/argparse.html
# - https://stackoverflow.com/questions/24180527

import argparse
import os
import subprocess
import sys

parser = argparse.ArgumentParser()
optional = parser._action_groups.pop()
required = parser.add_argument_group('required arguments')
required.add_argument( \
    "--organism", required=True, \
    help="latin name (e.g. \"Homo sapiens\")" \
)
required.add_argument( \
    "--build", required=True, \
    help="genome build (e.g. \"GRCh38\")" \
)
optional.add_argument( \
    "--release", \
    help="release version (e.g. \"96\")" \
)
parser._action_groups.append(optional)
args = parser.parse_args()

organism = args.organism.replace(" ", "_")
build = args.build

release = args.release
if release is None:
    release = subprocess.check_output( \
        "_koopa_variable ensembl_release_version", \
        shell=True, universal_newlines=True \
    )
    release = release.rstrip()

if build == "GRCh37":
    release = "87"
    base_url = "ftp://ftp.ensembl.org/pub/grch37"
else:
    base_url = "ftp://ftp.ensembl.org/pub"

url = base_url + "/release-" + release + "/gtf/" + organism.lower() + "/" + \
    organism + "." + build + "." + release + ".gtf.gz"
file = os.path.basename(url)

# Error if the file exists.
if os.path.isfile(file):
    print(file + " has already been downloaded.")
    sys.exit(0)

print("Downloading " + file + ".")
try:
    subprocess.check_call(["wget", url])
except subprocess.CalledProcessError as e:
    print("Failed to download " + file + ".")
    sys.exit(1)

# Decompress, but also keep the original compressed file.
print("Decompressing " + file + ".")
unzip_file = os.path.splitext(file)[0]
os.system("gunzip -c " + file + " > " + unzip_file)
