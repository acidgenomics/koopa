#!/usr/bin/env Rscript

options(
    "error" = quote(quit(status = 1L)),
    "warning" = quote(quit(status = 1L))
)

## """
## CRAN removals:
## > remove.packages("Matrix.utils")
## > remove.packages("ashr")
## > remove.packages("rgexf")
## > remove.packages("trimcluster")
##
## GitHub removals / renames:
## > remove.packages("bioverbs")
## > remove.packages("brio")
## > remove.packages("wormbase")
##
## Tricky packages:
## - Rcpp
## - RcppArmadillo
## - sf
## - XML
## """

args <- commandArgs(trailingOnly = FALSE)
whichFile <- grep(pattern = "--file", x = args)
file <- args[whichFile]
file <- sub(pattern = "^--file=", replacement = "", x = file)
koopaPrefix <- normalizePath(dirname(dirname(file)))
source(file.path(koopaPrefix, "lang", "r", "include", "header.R"))

## Install BiocManager first, if necessary.
if (!isTRUE(requireNamespace("BiocManager", quietly = TRUE))) {
    stopifnot(requireNamespace("utils"), quietly = TRUE)
    utils::install.packages("BiocManager")
}

h1("Installing R packages")

## Upgrade Bioconductor first, if desired.
## > install(
## >     update = TRUE,
## >     ask = FALSE,
## >     version = Sys.getenv("BIOC_VERSION")
## > )

h2("CRAN")
install(
    pkgs = c(
        "DT",
        "Matrix",
        "R.utils",
        "backports",
        "covr",
        "cowplot",
        "curl",
        "devtools",
        "ggrepel",
        "knitr",
        "lintr",
        "magrittr",
        "patrick",
        "pbapply",
        "rcmdcheck",
        "remotes",
        "reticulate",
        "rlang",
        "rmarkdown",
        "roxygen2",
        "sessioninfo",
        "testthat",
        "tidyverse",
        "viridis",
        "xmlparsedata"
    ),
    update = TRUE,
    ask = FALSE
)

h2("Bioconductor")
install(
    pkgs = c(
        "AnnotationDbi",
        "AnnotationHub",
        "Biobase",
        "BiocCheck",
        "BiocGenerics",
        "BiocParallel",
        "BiocStyle",
        "Biostrings",
        "DelayedArray",
        "DropletUtils",
        "GSEABase",
        "GenomeInfoDb",
        "GenomeInfoDbData",
        "GenomicAlignments",
        "GenomicFeatures",
        "GenomicRanges",
        "IRanges",
        "S4Vectors",
        "SingleCellExperiment",
        "SummarizedExperiment",
        "ensembldb",
        "rtracklayer"
    ),
    update = TRUE,
    ask = FALSE
)

# GitHub packages.
h2("GitHub")
if (isTRUE(nzchar(Sys.getenv("GITHUB_PAT")))) {
    install(
        pkgs = c(
            "acidgenomics/basejump",
            "acidgenomics/bb8"
        )
    )
} else {
    message("No 'GITHUB_PAT' key detected. Skipping.")
}
