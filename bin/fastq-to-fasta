#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../shell/bash/include/header.sh"


koopa::fastq_to_fasta() {
    # """
    # Convert FASTQ files into FASTA format.
    # @note Updated 2020-07-11.
    #
    # Alternate approaches:
    #
    # > seqtk seq -A
    # > bioawk -c fastx '{print ">" $name; print $seq}' "$fastq_file"
    # > cat "$fastq_file" \
    # >     | paste - - - - \
    # >     | awk -v FS="\t" '{print $1"\n"$2}' \
    # >     > "$fasta_file"
    # """
    local array fasta_file fastq_file source_dir target_dir 
    koopa::assert_has_args "$#"
    koopa::assert_is_installed cut find paste sed sort tr
    source_dir='.'
    target_dir='.'
    while (("$#"))
    do
        case "$1" in
            --source-dir=*)
                source_dir="${1#*=}"
                shift 1
                ;;
            --source-dir)
                source_dir="$2"
                shift 2
                ;;
            --target-dir=*)
                target_dir="${1#*=}"
                shift 1
                ;;
            --target-dir)
                target_dir="$2"
                shift 2
                ;;
            *)
                koopa::invalid_arg "$1"
                ;;
        esac
    done
    source_dir="$(koopa::strip_trailing_slash "$source_dir")"
    target_dir="$(koopa::strip_trailing_slash "$target_dir")"
    # Pipe GNU find into array.
    readarray -t array <<< "$( \
        find "$source_dir" \
            -maxdepth 1 \
            -mindepth 1 \
            -type f \
            -iname '*.fastq' \
            -print \
        | sort \
    )"
    [[ "${#array[@]}" -eq 0 ]] && koopa::stop 'No FASTQ files detected.'
    koopa::mkdir "$target_dir"
    for fastq_file in "${array[@]}"
    do
        fasta_file="${fastq_file%.fastq}.fasta"
        paste - - - - < "$fastq_file" \
            | cut -f 1,2 \
            | sed 's/^@/>/' \
            | tr "\t" "\n" > "$fasta_file"
    done
    return 0
}

koopa::fastq_to_fasta "$@"
