#!/usr/bin/env bash
set -Eeu -o pipefail

KOOPA_PREFIX="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_PREFIX}/shell/bash/include/header.sh"

_koopa_assert_has_args "$@"

fasta_file="$1"
_koopa_assert_is_file "$fasta_file"

output_file="${2:-"tx2gene.csv"}"
_koopa_assert_is_matching_fixed "$fasta_file" "dmel-transcriptome-"
_koopa_assert_is_not_file "$output_file"

_koopa_h1 "Generating '$(basename "$output_file")' from \
'$(basename "$fasta_file")'."

gunzip -c "$fasta_file" \
    | grep '>' \
    | cut -d ' ' -f1,9 \
    | tr -d '>' \
    | sed -E 's/ parent=(FBgn[0-9]{7}).*/,\1/g' \
    | awk '!a[$0]++' \
    > "$output_file"

# Return the number of transcripts.
count="$(_koopa_line_count "$output_file")"
_koopa_h1 "${count} transcripts detected."
