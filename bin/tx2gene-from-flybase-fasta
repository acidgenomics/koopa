#!/usr/bin/env bash

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)"
# shellcheck source=/dev/null
source "${script_dir}/../shell/bash/include/header.sh"

koopa::assert_has_args "$#"

fasta_file="$1"
koopa::assert_is_file "$fasta_file"

output_file="${2:-tx2gene.csv}"
koopa::assert_is_matching_fixed "$fasta_file" "dmel-transcriptome-"
koopa::assert_is_not_file "$output_file"

koopa::h1 "Generating '$(basename "$output_file")' from \
'$(basename "$fasta_file")'."

gunzip -c "$fasta_file" \
    | grep '>' \
    | cut -d ' ' -f1,9 \
    | tr -d '>' \
    | sed -E 's/ parent=(FBgn[0-9]{7}).*/,\1/g' \
    | awk '!a[$0]++' \
    > "$output_file"

# Return the number of transcripts.
count="$(koopa::line_count "$output_file")"
koopa::h1 "${count} transcripts detected."
