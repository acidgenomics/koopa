#!/usr/bin/env bash

KOOPA_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." \
    >/dev/null 2>&1 && pwd -P)"
# shellcheck source=/dev/null
source "${KOOPA_HOME}/shell/bash/include/header.sh"

_acid_assert_has_args "$@"

fasta_file="$1"
_acid_assert_is_file "$fasta_file"

output_file="${2:-"tx2gene.csv"}"
_acid_assert_is_matching_fixed "$fasta_file" "dmel-transcriptome-"
_acid_assert_is_not_file "$output_file"

_acid_message "Generating '$(basename "$output_file")' from \
'$(basename "$fasta_file")'."

gunzip -c "$fasta_file" \
    | grep '>' \
    | cut -d ' ' -f1,9 \
    | tr -d '>' \
    | sed -E 's/ parent=(FBgn[0-9]{7}).*/,\1/g' \
    | awk '!a[$0]++' \
    > "$output_file"

# Return the number of transcripts.
count="$(_acid_line_count "$output_file")"
_acid_message "${count} transcripts detected."
